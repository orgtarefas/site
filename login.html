<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Work Manager</title>
    <link rel="stylesheet" href="login.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo-container">
                    <img src="images/logo workyz.png" alt="Work Manager Logo" class="logo-image">
                </div>
                <p>Acesso Restrito</p>
            </div>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="loginUsuario">
                        <i class="fas fa-user"></i> Nome de Usu√°rio
                    </label>
                    <input type="text" id="loginUsuario" required placeholder="Seu nome de usu√°rio" autocomplete="username">
                </div>

                <div class="form-group">
                    <label for="loginPassword">
                        <i class="fas fa-lock"></i> Senha
                    </label>
                    <input type="password" id="loginPassword" required placeholder="Sua senha" autocomplete="current-password">
                </div>

                <div class="form-options">
                    <label class="checkbox-container">
                        <input type="checkbox" id="rememberMe">
                        <span class="checkmark"></span>
                        Lembrar-me
                    </label>
                </div>

                <button type="submit" class="btn-login" id="btnLogin">
                    <i class="fas fa-sign-in-alt"></i>
                    <span id="btnText">Entrar no Sistema</span>
                    <div class="spinner hidden" id="spinner"></div>
                </button>

                <div class="login-footer">
                    <p><i class="fas fa-shield-alt"></i> Sistema seguro - Acesso monitorado</p>
                </div>
            </form>
        </div>

        <div class="login-background">
            <div class="background-shapes">
                <div class="shape shape-1"></div>
                <div class="shape shape-2"></div>
                <div class="shape shape-3"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v12 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { 
            getFirestore, 
            doc,
            getDoc
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJpyAouZtwoWC0QDmTtpJxn0_j_w8DlvU",
            authDomain: "logins-c3407.firebaseapp.com",
            projectId: "logins-c3407",
            storageBucket: "logins-c3407.firebasestorage.app",
            messagingSenderId: "809861558230",
            appId: "1:809861558230:web:e6e41bf1db9b3cfd887e77"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.firebaseApp = {
            db,
            firebaseModules: {
                doc,
                getDoc
            }
        };
        console.log('‚úÖ Firebase logins-c3407 configurado!');
    </script>

    <!-- login.js INLINE - EXCLUSIVO PARA LOGINS_ORGTAREFAS -->
    <script>
        console.log('=== LOGIN INICIANDO (EXCLUSIVO LOGINS_ORGTAREFAS) ===');

        async function fazerLogin(usuario, senha) {
            console.log('üîê Tentando login para LOGINS_ORGTAREFAS:', usuario);
            
            const btnLogin = document.getElementById('btnLogin');
            const btnText = document.getElementById('btnText');
            const spinner = document.getElementById('spinner');
            
            try {
                if (!usuario || !senha) {
                    alert('Preencha usu√°rio e senha');
                    return;
                }

                btnLogin.disabled = true;
                btnText.textContent = 'Autenticando...';
                spinner.classList.remove('hidden');
                
                const { db, firebaseModules } = window.firebaseApp;
                const { doc, getDoc } = firebaseModules;
                
                console.log('üìä ACESSANDO EXCLUSIVAMENTE: logins/LOGINS_ORGTAREFAS');
                
                // SOMENTE LOGINS_ORGTAREFAS
                const docRef = doc(db, 'logins', 'LOGINS_ORGTAREFAS');
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    throw new Error('Documento LOGINS_ORGTAREFAS n√£o encontrado!');
                }
                
                const dadosCompletos = docSnap.data();
                console.log('‚úÖ LOGINS_ORGTAREFAS carregado. Campos:', Object.keys(dadosCompletos).length);
                
                // MOSTRAR TODA A ESTRUTURA PARA DEBUG
                console.log('üìã ESTRUTURA COMPLETA DE LOGINS_ORGTAREFAS:');
                Object.keys(dadosCompletos).forEach(campo => {
                    console.log(`${campo}:`, dadosCompletos[campo]);
                });
                
                // BUSCAR USU√ÅRIO - ESTRUTURA ESPERADA:
                // Campos como: login, senha, displayName, perfil, status, isOnline
                let usuarioEncontrado = null;
                let userId = null;
                
                // Procurar em TODOS os campos
                const todosCampos = Object.keys(dadosCompletos);
                
                // ESTRUTURA 1: Campos diretos (login_1, senha_1, etc.)
                for (let i = 1; i <= 50; i++) {
                    const possiveisLogins = [
                        `login_${i}`,
                        `usuario_${i}`,
                        `user_${i}_login`,
                        `user_${i}_usuario`
                    ];
                    
                    for (const campoLogin of possiveisLogins) {
                        if (dadosCompletos[campoLogin] === usuario) {
                            console.log(`‚úÖ Usu√°rio encontrado em: ${campoLogin}`);
                            
                            // Procurar campos relacionados
                            const campoSenha = encontrarCampoSenha(dadosCompletos, i);
                            const campoNome = encontrarCampoNome(dadosCompletos, i);
                            const campoPerfil = encontrarCampoPerfil(dadosCompletos, i);
                            const campoStatus = encontrarCampoStatus(dadosCompletos, i);
                            
                            usuarioEncontrado = {
                                login: dadosCompletos[campoLogin],
                                senha: campoSenha ? dadosCompletos[campoSenha] : null,
                                nome: campoNome ? dadosCompletos[campoNome] : null,
                                perfil: campoPerfil ? dadosCompletos[campoPerfil] : null,
                                status: campoStatus ? dadosCompletos[campoStatus] : 'ativo'
                            };
                            userId = `user_${i}`;
                            break;
                        }
                    }
                    if (usuarioEncontrado) break;
                }
                
                // ESTRUTURA 2: Objetos (user1: {login:..., senha:...})
                if (!usuarioEncontrado) {
                    for (const campo of todosCampos) {
                        const valor = dadosCompletos[campo];
                        if (valor && typeof valor === 'object') {
                            if (valor.login === usuario || valor.usuario === usuario) {
                                console.log(`‚úÖ Usu√°rio encontrado no objeto: ${campo}`);
                                usuarioEncontrado = valor;
                                userId = campo;
                                break;
                            }
                        }
                    }
                }
                
                if (!usuarioEncontrado) {
                    console.log('‚ùå Usu√°rio n√£o encontrado em LOGINS_ORGTAREFAS');
                    console.log('Campos dispon√≠veis:', todosCampos);
                    throw new Error('Usu√°rio n√£o encontrado em LOGINS_ORGTAREFAS');
                }
                
                console.log('üéØ Dados do usu√°rio encontrado:', usuarioEncontrado);
                
                // VERIFICA√á√ïES
                if (!usuarioEncontrado.senha) {
                    throw new Error('Campo de senha n√£o encontrado');
                }
                
                if (usuarioEncontrado.senha !== senha) {
                    console.log('üîç Compara√ß√£o de senha:');
                    console.log('Banco:', usuarioEncontrado.senha);
                    console.log('Digitada:', senha);
                    throw new Error('Senha incorreta');
                }
                
                console.log('‚úÖ Senha correta!');
                
                // IGNORAR VERIFICA√á√ÉO DE STATUS POR ENQUANTO
                if (usuarioEncontrado.status && usuarioEncontrado.status.toLowerCase() === 'inativo') {
                    console.log('‚ö†Ô∏è Usu√°rio est√° como "InAtivo" no banco, mas permitindo login...');
                }
                
                // SALVAR DADOS
                const usuarioLogado = {
                    id: userId,
                    uid: userId,
                    usuario: usuarioEncontrado.login || usuario,
                    nome: usuarioEncontrado.nome || 
                         usuarioEncontrado.displayName || 
                         usuarioEncontrado.name || 
                         usuario,
                    perfil: usuarioEncontrado.perfil || 
                           usuarioEncontrado.nivel || 
                           usuarioEncontrado.profile || 
                           'usuario',
                    email: usuarioEncontrado.email || '',
                    status: usuarioEncontrado.status || 'ativo',
                    isOnline: usuarioEncontrado.isOnline || false,
                    documento: 'LOGINS_ORGTAREFAS',
                    dataLogin: new Date().toISOString()
                };
                
                localStorage.setItem('usuarioLogado', JSON.stringify(usuarioLogado));
                
                const rememberMe = document.getElementById('rememberMe').checked;
                if (rememberMe) {
                    localStorage.setItem('savedUser', usuario);
                } else {
                    localStorage.removeItem('savedUser');
                }
                
                console.log('‚úÖ Login realizado com sucesso no LOGINS_ORGTAREFAS!');
                console.log('üìã Dados salvos:', usuarioLogado);
                
                btnText.textContent = '‚úÖ Redirecionando...';
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Erro no login:', error);
                alert('Erro: ' + error.message);
                
                btnLogin.disabled = false;
                btnText.textContent = 'Entrar no Sistema';
                spinner.classList.add('hidden');
            }
        }

        // FUN√á√ïES AUXILIARES
        function encontrarCampoSenha(dados, numero) {
            const possiveis = [
                `senha_${numero}`,
                `password_${numero}`,
                `user_${numero}_senha`,
                `user_${numero}_password`
            ];
            return possiveis.find(campo => campo in dados);
        }
        
        function encontrarCampoNome(dados, numero) {
            const possiveis = [
                `nome_${numero}`,
                `name_${numero}`,
                `displayName_${numero}`,
                `user_${numero}_nome`,
                `user_${numero}_name`,
                `user_${numero}_displayName`
            ];
            return possiveis.find(campo => campo in dados);
        }
        
        function encontrarCampoPerfil(dados, numero) {
            const possiveis = [
                `perfil_${numero}`,
                `profile_${numero}`,
                `nivel_${numero}`,
                `role_${numero}`,
                `user_${numero}_perfil`,
                `user_${numero}_profile`,
                `user_${numero}_nivel`,
                `user_${numero}_role`
            ];
            return possiveis.find(campo => campo in dados);
        }
        
        function encontrarCampoStatus(dados, numero) {
            const possiveis = [
                `status_${numero}`,
                `ativo_${numero}`,
                `user_${numero}_status`,
                `user_${numero}_ativo`
            ];
            return possiveis.find(campo => campo in dados);
        }

        // FUN√á√ÉO PARA VER ESTRUTURA DO LOGINS_ORGTAREFAS
        window.verEstruturaLOGINS_ORGTAREFAS = async function() {
            try {
                const { db, firebaseModules } = window.firebaseApp;
                const { doc, getDoc } = firebaseModules;
                
                console.log('üîç ANALISANDO LOGINS_ORGTAREFAS...');
                
                const docRef = doc(db, 'logins', 'LOGINS_ORGTAREFAS');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const dados = docSnap.data();
                    console.log('üìä LOGINS_ORGTAREFAS - ESTRUTURA COMPLETA:');
                    console.log('Total de campos:', Object.keys(dados).length);
                    
                    // Mostrar todos os campos
                    Object.keys(dados).forEach((campo, index) => {
                        const valor = dados[campo];
                        if (typeof valor === 'object') {
                            console.log(`${index + 1}. ${campo}:`, valor);
                        } else {
                            console.log(`${index + 1}. ${campo}: ${valor}`);
                        }
                    });
                    
                    return dados;
                } else {
                    console.log('‚ùå Documento LOGINS_ORGTAREFAS n√£o encontrado!');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                return null;
            }
        };

        // CONFIGURA√á√ÉO DO FORMUL√ÅRIO
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== FORMUL√ÅRIO PRONTO ===');
            
            const form = document.getElementById('loginForm');
            const usuarioInput = document.getElementById('loginUsuario');
            const senhaInput = document.getElementById('loginPassword');
            
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const usuario = usuarioInput.value.trim();
                    const senha = senhaInput.value;
                    
                    console.log('üì§ Formul√°rio enviado para LOGINS_ORGTAREFAS:', { usuario });
                    fazerLogin(usuario, senha);
                });
            }
            
            usuarioInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    senhaInput.focus();
                }
            });
            
            senhaInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    form.dispatchEvent(new Event('submit'));
                }
            });
            
            const savedUser = localStorage.getItem('savedUser');
            if (savedUser) {
                usuarioInput.value = savedUser;
                document.getElementById('rememberMe').checked = true;
                senhaInput.focus();
            } else {
                usuarioInput.focus();
            }
            
            console.log('üöÄ SISTEMA CONFIGURADO EXCLUSIVAMENTE PARA LOGINS_ORGTAREFAS');
            console.log('üí° Dica: Use verEstruturaLOGINS_ORGTAREFAS() no console');
        });

        window.testeLogin = function(usuario, senha) {
            document.getElementById('loginUsuario').value = usuario;
            document.getElementById('loginPassword').value = senha;
            document.getElementById('loginForm').dispatchEvent(new Event('submit'));
        };
    </script>
</body>
</html>
