<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Manager - Sistema de Grupos</title>
    <link rel="stylesheet" href="workmanager.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Tela de Carregamento -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <i class="fas fa-users fa-spin"></i>
            <p id="loadingText">Conectando ao banco de dados...</p>
        </div>
    </div>

    <div class="workmanager-container" id="mainContent" style="display: none;">
        <!-- Cabe√ßalho -->
        <header class="workmanager-header">
            <div class="header-left">
                <i class="fas fa-users"></i>
                <h1>Work Manager</h1>
                <span class="subtitle">Gest√£o Colaborativa</span>
            </div>
            <div class="header-right">
                <button class="btn btn-outline" onclick="window.location.href='index.html'">
                    <i class="fas fa-tasks"></i> Tarefas
                </button>
                <button class="btn btn-outline" onclick="window.location.href='dashboard.html'">
                    <i class="fas fa-chart-line"></i> Minhas Atividades
                </button>
                <button class="btn btn-primary" onclick="abrirModalGrupo()">
                    <i class="fas fa-plus-circle"></i> Novo Grupo
                </button>
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span id="userName">Usu√°rio</span>
                </div>
            </div>
        </header>

        <!-- Status -->
        <div class="sync-status" id="syncStatus">
            <i class="fas fa-sync-alt fa-spin"></i>
            <span>Estabelecendo conex√£o...</span>
        </div>

        <!-- Filtros e Tabs -->
        <div class="workmanager-tabs">
            <div class="tabs">
                <button class="tab active" onclick="filtrarGrupos('meus')">
                    <i class="fas fa-user-circle"></i> Meus Grupos
                </button>
                <button class="tab" onclick="filtrarGrupos('convidados')">
                    <i class="fas fa-envelope"></i> Convites
                    <span class="badge" id="badgeConvites">0</span>
                </button>
                <button class="tab" onclick="filtrarGrupos('todos')">
                    <i class="fas fa-globe"></i> Todos
                </button>
            </div>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchGroups" placeholder="Buscar grupos...">
            </div>
        </div>

        <!-- Container de Grupos -->
        <div class="groups-container" id="groupsContainer">
            <!-- Grupos ser√£o carregados aqui -->
        </div>

        <!-- Modal para Criar/Editar Grupo -->
        <div id="modalGrupo" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalGrupoTitulo">Novo Grupo de Trabalho</h2>
                    <button class="close" onclick="fecharModalGrupo()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="formGrupo">
                        <div class="form-group">
                            <label for="grupoNome"><i class="fas fa-tag"></i> Nome do Grupo *</label>
                            <input type="text" id="grupoNome" class="form-control" required 
                                   placeholder="Ex: Projeto Alpha - Desenvolvimento">
                        </div>
                        <div class="form-group">
                            <label for="grupoDescricao"><i class="fas fa-align-left"></i> Descri√ß√£o</label>
                            <textarea id="grupoDescricao" class="form-control" rows="3" 
                                      placeholder="Descreva o objetivo do grupo..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="grupoCor"><i class="fas fa-palette"></i> Cor de Identifica√ß√£o</label>
                            <input type="color" id="grupoCor" class="form-control" value="#4a6fa5">
                        </div>
                        <!-- Buscar usu√°rios -->
                        <div class="form-group" id="usuariosContainer">
                            <label><i class="fas fa-user-plus"></i> Adicionar Membros (opcional)</label>
                            <div class="input-group">
                                <input type="text" id="buscarUsuario" class="form-control" 
                                       placeholder="Buscar usu√°rios pelo nome ou email..."
                                       onkeyup="filtrarUsuarios(this.value)">
                                <button type="button" class="btn btn-outline" onclick="carregarUsuarios()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="usuarios-lista" id="usuariosLista" style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                                <!-- Usu√°rios ser√£o carregados aqui -->
                                <div class="empty-membros">
                                    <i class="fas fa-user-plus"></i>
                                    <span>Carregando usu√°rios...</span>
                                </div>
                            </div>
                            <div class="membros-selecionados" id="membrosSelecionados" style="margin-top: 15px;">
                                <h4>Membros Selecionados:</h4>
                                <div id="listaMembrosSelecionados">
                                    <!-- Membros selecionados aparecer√£o aqui -->
                                </div>
                            </div>
                            <small class="text-muted">Selecione os usu√°rios que deseja adicionar ao grupo.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="fecharModalGrupo()">Cancelar</button>
                    <button class="btn btn-primary" onclick="salvarGrupo()">
                        <i class="fas fa-save"></i> Criar Grupo
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal para Gerenciar Membros -->
        <div id="modalMembros" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-users-cog"></i> Gerenciar Membros</h2>
                    <button class="close" onclick="fecharModalMembros()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="membrosAtuaisLista">
                        <!-- Membros ser√£o carregados aqui -->
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label><i class="fas fa-user-plus"></i> Adicionar Novo Membro</label>
                        <div class="input-group">
                            <input type="text" id="buscarUsuarioParaConvite" class="form-control" 
                                   placeholder="Buscar usu√°rios pelo nome ou email..."
                                   onkeyup="filtrarUsuariosParaConvite(this.value)">
                            <button type="button" class="btn btn-primary" onclick="convidarUsuarioSelecionado()">
                                <i class="fas fa-paper-plane"></i> Convidar
                            </button>
                        </div>
                        <div class="usuarios-lista" id="usuariosParaConvite" style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                            <!-- Usu√°rios para convite -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="fecharModalMembros()">Fechar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Confirma√ß√£o -->
        <div id="modalConfirmacao" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h2 id="confirmacaoTitulo">Confirma√ß√£o</h2>
                    <button class="close" onclick="fecharModalConfirmacao()">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="confirmacaoMensagem">Tem certeza que deseja realizar esta a√ß√£o?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="fecharModalConfirmacao()">Cancelar</button>
                    <button class="btn btn-primary" onclick="confirmarAcao()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase v12 -->
    <script type="module">
        console.log('=== INICIANDO FIREBASE v12 ===');
        
        const firebaseConfig = {
            apiKey: "AIzaSyAs0Ke4IBfBWDrfH0AXaOhCEjtfpPtR_Vg",
            authDomain: "orgtarefas-85358.firebaseapp.com",
            projectId: "orgtarefas-85358",
            storageBucket: "orgtarefas-85358.firebasestorage.app",
            messagingSenderId: "1023569488575",
            appId: "1:1023569488575:web:18f9e201115a1a92ccb40a"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs,
            getDoc,
            serverTimestamp,
            query,
            where,
            onSnapshot,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            arrayUnion,
            arrayRemove,
            setDoc
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            
            window.firebaseModules = {
                db,
                collection, getDocs, getDoc, serverTimestamp,
                query, where, onSnapshot,
                addDoc, updateDoc, deleteDoc, doc, setDoc,
                arrayUnion, arrayRemove,
                app
            };
            
            console.log('‚úÖ Firebase v12 inicializado com sucesso!');
            
            const loadingText = document.getElementById('loadingText');
            if (loadingText) {
                loadingText.textContent = 'Firebase conectado! Carregando dados...';
            }
            
            if (window.onFirebaseReady) {
                window.onFirebaseReady();
            }
            
        } catch (error) {
            console.error('‚ùå ERRO CR√çTICO ao inicializar Firebase:', error);
            
            const loadingText = document.getElementById('loadingText');
            if (loadingText) {
                loadingText.innerHTML = '<span style="color: #e74c3c;">‚ùå Erro ao conectar com Firebase</span>';
            }
            
            window.firebaseModules = null;
        }
    </script>

    <!-- Sistema Work Manager COMPLETO -->
    <script>
        console.log('=== WORK MANAGER COMPLETO ===');
        
        class WorkManager {
            constructor() {
                console.log('üöÄ Work Manager inicializando...');
                this.usuarioAtual = null;
                this.grupos = [];
                this.filtroAtual = 'meus';
                this.grupoEditando = null;
                this.usuarios = []; // Lista de usu√°rios do sistema
                this.membrosSelecionados = new Set(); // Usu√°rios selecionados para adicionar
                this.grupoSelecionado = null;
                this.acaoConfirmacao = null;
                this.dadosConfirmacao = null;
                this.usuarioParaConvitar = null;
            }
            
            async init() {
                console.log('üì± Iniciando sistema...');
                
                // 1. Verificar login
                this.verificarLogin();
                
                // 2. Aguardar Firebase
                await this.aguardarFirebase();
                
                // 3. Carregar dados
                await this.carregarDados();
                
                // 4. Carregar usu√°rios
                await this.carregarUsuarios();
            }
            
            verificarLogin() {
                try {
                    const usuarioLogado = localStorage.getItem('usuarioLogado');
                    if (!usuarioLogado) {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    this.usuarioAtual = JSON.parse(usuarioLogado);
                    
                    if (document.getElementById('userName')) {
                        document.getElementById('userName').textContent = 
                            this.usuarioAtual.nome || this.usuarioAtual.usuario;
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro ao verificar login:', error);
                    window.location.href = 'login.html';
                }
            }
            
            async aguardarFirebase() {
                return new Promise((resolve) => {
                    const checkFirebase = () => {
                        if (window.firebaseModules && window.firebaseModules.db) {
                            console.log('‚úÖ Firebase dispon√≠vel!');
                            resolve();
                        } else {
                            setTimeout(checkFirebase, 500);
                        }
                    };
                    
                    checkFirebase();
                });
            }
            
            async carregarDados() {
                try {
                    if (!window.firebaseModules || !window.firebaseModules.db) {
                        throw new Error('Firebase n√£o dispon√≠vel');
                    }
                    
                    const modules = window.firebaseModules;
                    
                    this.atualizarStatus('üì° Conectando ao banco de dados...');
                    
                    // Carregar grupos do usu√°rio
                    await this.carregarGrupos();
                    
                    // Mostrar interface
                    this.mostrarInterface();
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar dados:', error);
                    this.mostrarErroConexao();
                }
            }
            
            async carregarUsuarios() {
                try {
                    const modules = window.firebaseModules;
                    const usuariosRef = modules.collection(modules.db, 'usuarios');
                    const snapshot = await modules.getDocs(usuariosRef);
                    
                    this.usuarios = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data
                        };
                    }).filter(usuario => 
                        // Filtrar o usu√°rio atual
                        usuario.id !== this.usuarioAtual.usuario
                    );
                    
                    console.log(`‚úÖ ${this.usuarios.length} usu√°rios carregados`);
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar usu√°rios:', error);
                    this.usuarios = [];
                }
            }
            
            async carregarGrupos() {
                try {
                    const modules = window.firebaseModules;
                    
                    // Buscar grupos onde o usu√°rio √© membro
                    const gruposRef = modules.collection(modules.db, 'grupos');
                    const q = modules.query(
                        gruposRef,
                        modules.where('membros', 'array-contains', this.usuarioAtual.usuario)
                    );
                    
                    const snapshot = await modules.getDocs(q);
                    
                    this.grupos = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            minhaPermissao: this.obterMinhaPermissao(data),
                            membroAtual: this.obterMembroAtual(data)
                        };
                    });
                    
                    console.log(`‚úÖ ${this.grupos.length} grupos carregados`);
                    this.atualizarStatus('‚úÖ Conectado - ' + this.grupos.length + ' grupos');
                    
                    // Configurar listener em tempo real
                    this.configurarListenerTempoReal(q);
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar grupos:', error);
                    throw error;
                }
            }
            
            obterMinhaPermissao(grupo) {
                if (!grupo.membros || !Array.isArray(grupo.membros)) return null;
                
                // Primeiro verifica se √© uma string simples
                if (grupo.membros.some(m => m === this.usuarioAtual.usuario)) {
                    return 'membro';
                }
                
                // Depois verifica se √© um objeto
                for (const membro of grupo.membros) {
                    if (membro && typeof membro === 'object') {
                        if (membro.usuarioId === this.usuarioAtual.usuario) {
                            return membro.permissao || 'membro';
                        }
                    }
                }
                
                return null;
            }
            
            obterMembroAtual(grupo) {
                if (!grupo.membros || !Array.isArray(grupo.membros)) return null;
                
                // Primeiro verifica se √© uma string simples
                if (grupo.membros.some(m => m === this.usuarioAtual.usuario)) {
                    return { usuarioId: this.usuarioAtual.usuario, permissao: 'membro' };
                }
                
                // Depois verifica se √© um objeto
                for (const membro of grupo.membros) {
                    if (membro && typeof membro === 'object') {
                        if (membro.usuarioId === this.usuarioAtual.usuario) {
                            return membro;
                        }
                    }
                }
                
                return null;
            }
            
            configurarListenerTempoReal(q) {
                try {
                    const modules = window.firebaseModules;
                    
                    const unsubscribe = modules.onSnapshot(q, 
                        (snapshot) => {
                            console.log('üîÑ Grupos atualizados em tempo real:', snapshot.size);
                            
                            this.grupos = snapshot.docs.map(doc => {
                                const data = doc.data();
                                return {
                                    id: doc.id,
                                    ...data,
                                    minhaPermissao: this.obterMinhaPermissao(data),
                                    membroAtual: this.obterMembroAtual(data)
                                };
                            });
                            
                            this.atualizarInterfaceGrupos();
                            this.atualizarBadgeConvites();
                        },
                        (error) => {
                            console.error('‚ùå Erro no listener:', error);
                            this.atualizarStatus('‚ö†Ô∏è Sincroniza√ß√£o interrompida');
                        }
                    );
                    
                    this.unsubscribe = unsubscribe;
                    
                } catch (error) {
                    console.error('‚ùå Erro ao configurar listener:', error);
                }
            }
            
            mostrarInterface() {
                const loadingScreen = document.getElementById('loadingScreen');
                const mainContent = document.getElementById('mainContent');
                
                if (loadingScreen) loadingScreen.style.display = 'none';
                if (mainContent) mainContent.style.display = 'block';
                
                this.atualizarInterfaceGrupos();
                this.configurarEventos();
            }
            
            mostrarErroConexao() {
                const loadingScreen = document.getElementById('loadingScreen');
                const mainContent = document.getElementById('mainContent');
                
                if (loadingScreen) loadingScreen.style.display = 'none';
                if (mainContent) mainContent.style.display = 'block';
                
                const container = document.getElementById('groupsContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <i class="fas fa-exclamation-triangle" style="color: #e74c3c; font-size: 3rem;"></i>
                            <h3 style="color: #e74c3c;">Erro de Conex√£o</h3>
                            <p>N√£o foi poss√≠vel conectar ao banco de dados Firebase.</p>
                            <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px;">
                                <i class="fas fa-redo"></i> Tentar Novamente
                            </button>
                        </div>
                    `;
                }
                
                this.atualizarStatus('‚ùå Erro de conex√£o');
            }
            
            atualizarStatus(mensagem) {
                const syncStatus = document.getElementById('syncStatus');
                if (syncStatus) {
                    const icon = mensagem.includes('‚úÖ') ? 'check-circle' : 
                                mensagem.includes('‚ùå') ? 'exclamation-triangle' :
                                mensagem.includes('‚ö†Ô∏è') ? 'exclamation-triangle' :
                                mensagem.includes('üì°') ? 'sync-alt fa-spin' : 'info-circle';
                    
                    syncStatus.innerHTML = `
                        <i class="fas fa-${icon}"></i>
                        <span>${mensagem}</span>
                    `;
                }
            }
            
            atualizarInterfaceGrupos() {
                const container = document.getElementById('groupsContainer');
                if (!container) return;
                
                const gruposFiltrados = this.filtrarGrupos(this.filtroAtual);
                
                if (gruposFiltrados.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users-slash"></i>
                            <h3>Nenhum grupo encontrado</h3>
                            <p>${this.filtroAtual === 'meus' ? 'Voc√™ ainda n√£o faz parte de nenhum grupo de trabalho.' :
                              this.filtroAtual === 'convidados' ? 'Voc√™ n√£o tem convites pendentes.' :
                              'N√£o h√° grupos dispon√≠veis.'}</p>
                            ${this.filtroAtual === 'meus' ? `
                                <button class="btn btn-primary" onclick="abrirModalGrupo()" style="margin-top: 15px;">
                                    <i class="fas fa-plus-circle"></i> Criar Primeiro Grupo
                                </button>
                            ` : ''}
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = gruposFiltrados.map(grupo => {
                    const permissaoClass = grupo.minhaPermissao === 'pendente' ? 'convite-pendente' : grupo.minhaPermissao;
                    const membrosCount = Array.isArray(grupo.membros) ? grupo.membros.length : 0;
                    const tarefasCount = Array.isArray(grupo.tarefas) ? grupo.tarefas.length : 0;
                    
                    return `
                        <div class="group-card permissao-${permissaoClass}">
                            <div class="group-header" style="border-left-color: ${grupo.cor || '#4a6fa5'}">
                                <div class="group-title">
                                    <h3>${grupo.nome}</h3>
                                    <span class="permissao-badge ${grupo.minhaPermissao}">
                                        ${grupo.minhaPermissao === 'pendente' ? 'Convite' : 
                                         grupo.minhaPermissao === 'admin' ? 'Administrador' : 'Membro'}
                                    </span>
                                </div>
                                <div class="group-desc">${grupo.descricao || 'Sem descri√ß√£o'}</div>
                                <div class="group-meta">
                                    <div class="group-stats">
                                        <div class="group-stat">
                                            <i class="fas fa-users"></i>
                                            <span>${membrosCount} membro${membrosCount !== 1 ? 's' : ''}</span>
                                        </div>
                                        <div class="group-stat">
                                            <i class="fas fa-tasks"></i>
                                            <span>${tarefasCount} tarefa${tarefasCount !== 1 ? 's' : ''}</span>
                                        </div>
                                    </div>
                                    <small><i class="fas fa-calendar"></i> ${this.formatarData(grupo.dataCriacao)}</small>
                                </div>
                            </div>
                            <div class="group-actions">
                                ${grupo.minhaPermissao === 'pendente' ? `
                                    <button class="btn btn-success btn-sm" onclick="workManager.responderConvite('${grupo.id}', 'aceitar')">
                                        <i class="fas fa-check"></i> Aceitar
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="workManager.responderConvite('${grupo.id}', 'recusar')">
                                        <i class="fas fa-times"></i> Recusar
                                    </button>
                                ` : `
                                    <button class="btn btn-outline btn-sm" onclick="workManager.verDetalhesGrupo('${grupo.id}')">
                                        <i class="fas fa-eye"></i> Ver
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="workManager.gerenciarMembros('${grupo.id}')">
                                        <i class="fas fa-users-cog"></i> Membros
                                    </button>
                                    ${grupo.minhaPermissao === 'admin' ? `
                                        <button class="btn btn-warning btn-sm" onclick="workManager.editarGrupo('${grupo.id}')">
                                            <i class="fas fa-edit"></i> Editar
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="workManager.excluirGrupo('${grupo.id}')">
                                            <i class="fas fa-trash"></i> Excluir
                                        </button>
                                    ` : `
                                        <button class="btn btn-danger btn-sm" onclick="workManager.sairGrupo('${grupo.id}')">
                                            <i class="fas fa-sign-out-alt"></i> Sair
                                        </button>
                                    `}
                                `}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            filtrarGrupos(filtro, termoBusca = '') {
                let gruposFiltrados = this.grupos;
                
                switch(filtro) {
                    case 'meus':
                        gruposFiltrados = gruposFiltrados.filter(g => 
                            g.minhaPermissao !== 'pendente' && g.minhaPermissao !== null
                        );
                        break;
                    case 'convidados':
                        gruposFiltrados = gruposFiltrados.filter(g => 
                            g.minhaPermissao === 'pendente'
                        );
                        break;
                    case 'todos':
                        // Mostra todos os grupos onde o usu√°rio tem acesso
                        gruposFiltrados = gruposFiltrados.filter(g => g.minhaPermissao !== null);
                        break;
                }
                
                if (termoBusca) {
                    const termo = termoBusca.toLowerCase();
                    gruposFiltrados = gruposFiltrados.filter(g => 
                        g.nome.toLowerCase().includes(termo) ||
                        (g.descricao && g.descricao.toLowerCase().includes(termo))
                    );
                }
                
                return gruposFiltrados;
            }
            
            configurarEventos() {
                const searchInput = document.getElementById('searchGroups');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const gruposFiltrados = this.filtrarGrupos(this.filtroAtual, e.target.value);
                        this.atualizarInterfaceComGrupos(gruposFiltrados);
                    });
                }
            }
            
            atualizarBadgeConvites() {
                const badge = document.getElementById('badgeConvites');
                if (badge) {
                    const convitesPendentes = this.grupos.filter(g => g.minhaPermissao === 'pendente').length;
                    badge.textContent = convitesPendentes;
                    badge.style.display = convitesPendentes > 0 ? 'inline-block' : 'none';
                }
            }
            
            formatarData(data) {
                if (!data) return 'Data n√£o dispon√≠vel';
                const date = data.toDate ? data.toDate() : new Date(data);
                return date.toLocaleDateString('pt-BR');
            }
            
            // ========== CRIA√á√ÉO DE GRUPOS ==========
            
            async abrirModalGrupo(grupoId = null) {
                this.grupoEditando = grupoId;
                this.membrosSelecionados.clear();
                
                const modal = document.getElementById('modalGrupo');
                const titulo = document.getElementById('modalGrupoTitulo');
                const btnSalvar = document.querySelector('#modalGrupo .btn-primary');
                
                if (grupoId) {
                    // Modo edi√ß√£o
                    const grupo = this.grupos.find(g => g.id === grupoId);
                    if (!grupo) return;
                    
                    titulo.textContent = 'Editar Grupo';
                    btnSalvar.innerHTML = '<i class="fas fa-save"></i> Salvar Altera√ß√µes';
                    
                    document.getElementById('grupoNome').value = grupo.nome || '';
                    document.getElementById('grupoDescricao').value = grupo.descricao || '';
                    document.getElementById('grupoCor').value = grupo.cor || '#4a6fa5';
                    
                    // Carregar membros j√° existentes
                    if (grupo.membros && Array.isArray(grupo.membros)) {
                        for (const membro of grupo.membros) {
                            if (membro && typeof membro === 'object' && membro.usuarioId !== this.usuarioAtual.usuario) {
                                this.membrosSelecionados.add(membro.usuarioId);
                            }
                        }
                    }
                    
                } else {
                    // Modo cria√ß√£o
                    titulo.textContent = 'Novo Grupo de Trabalho';
                    btnSalvar.innerHTML = '<i class="fas fa-save"></i> Criar Grupo';
                    
                    document.getElementById('grupoNome').value = '';
                    document.getElementById('grupoDescricao').value = '';
                    document.getElementById('grupoCor').value = '#4a6fa5';
                }
                
                // Atualizar lista de usu√°rios e membros selecionados
                await this.carregarUsuarios();
                this.exibirUsuarios();
                this.atualizarListaMembrosSelecionados();
                
                modal.style.display = 'block';
            }
            
            fecharModalGrupo() {
                const modal = document.getElementById('modalGrupo');
                modal.style.display = 'none';
                this.grupoEditando = null;
                this.membrosSelecionados.clear();
            }
            
            async salvarGrupo() {
                try {
                    const modules = window.firebaseModules;
                    if (!modules || !modules.db) {
                        throw new Error('Firebase n√£o dispon√≠vel');
                    }
                    
                    const nome = document.getElementById('grupoNome').value.trim();
                    if (!nome) {
                        this.mostrarAlerta('‚ö†Ô∏è Por favor, informe um nome para o grupo', 'warning');
                        return;
                    }
                    
                    const descricao = document.getElementById('grupoDescricao').value.trim();
                    const cor = document.getElementById('grupoCor').value;
                    
                    if (this.grupoEditando) {
                        // Editar grupo existente
                        await this.editarGrupoFirebase(this.grupoEditando, nome, descricao, cor);
                        this.mostrarAlerta('‚úÖ Grupo atualizado com sucesso!', 'success');
                    } else {
                        // Criar novo grupo
                        const grupoData = {
                            nome: nome,
                            descricao: descricao || '',
                            cor: cor,
                            criador: this.usuarioAtual.usuario,
                            criadorNome: this.usuarioAtual.nome || this.usuarioAtual.usuario,
                            dataCriacao: modules.serverTimestamp(),
                            dataAtualizacao: modules.serverTimestamp(),
                            membros: [
                                this.usuarioAtual.usuario // Criador como primeiro membro (string simples)
                            ],
                            tarefas: []
                        };
                        
                        // Adicionar outros membros selecionados
                        for (const usuarioId of this.membrosSelecionados) {
                            grupoData.membros.push(usuarioId);
                        }
                        
                        console.log('üìù Salvando grupo:', grupoData);
                        
                        const gruposRef = modules.collection(modules.db, 'grupos');
                        const docRef = await modules.addDoc(gruposRef, grupoData);
                        
                        console.log('‚úÖ Grupo criado com ID:', docRef.id);
                        this.mostrarAlerta('‚úÖ Grupo criado com sucesso!', 'success');
                    }
                    
                    this.fecharModalGrupo();
                    
                } catch (error) {
                    console.error('‚ùå Erro ao salvar grupo:', error);
                    this.mostrarAlerta(`‚ùå Erro: ${error.message}`, 'error');
                }
            }
            
            async editarGrupoFirebase(grupoId, nome, descricao, cor) {
                const modules = window.firebaseModules;
                const grupoRef = modules.doc(modules.db, 'grupos', grupoId);
                
                await modules.updateDoc(grupoRef, {
                    nome: nome,
                    descricao: descricao || '',
                    cor: cor,
                    dataAtualizacao: modules.serverTimestamp()
                });
            }
            
            // ========== GERENCIAMENTO DE USU√ÅRIOS ==========
            
            async carregarUsuarios() {
                try {
                    const modules = window.firebaseModules;
                    const usuariosRef = modules.collection(modules.db, 'usuarios');
                    const snapshot = await modules.getDocs(usuariosRef);
                    
                    this.usuarios = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data
                        };
                    }).filter(usuario => 
                        // Filtrar o usu√°rio atual
                        usuario.id !== this.usuarioAtual.usuario
                    );
                    
                    console.log(`‚úÖ ${this.usuarios.length} usu√°rios carregados`);
                    return this.usuarios;
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar usu√°rios:', error);
                    this.usuarios = [];
                    return [];
                }
            }
            
            exibirUsuarios(termoBusca = '') {
                const container = document.getElementById('usuariosLista');
                if (!container) return;
                
                let usuariosFiltrados = this.usuarios;
                
                if (termoBusca) {
                    const termo = termoBusca.toLowerCase();
                    usuariosFiltrados = usuariosFiltrados.filter(usuario =>
                        (usuario.nome && usuario.nome.toLowerCase().includes(termo)) ||
                        (usuario.email && usuario.email.toLowerCase().includes(termo)) ||
                        usuario.id.toLowerCase().includes(termo)
                    );
                }
                
                if (usuariosFiltrados.length === 0) {
                    container.innerHTML = `
                        <div class="empty-membros">
                            <i class="fas fa-search"></i>
                            <span>Nenhum usu√°rio encontrado</span>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = usuariosFiltrados.map(usuario => {
                    const estaSelecionado = this.membrosSelecionados.has(usuario.id);
                    
                    return `
                        <div class="usuario-item ${estaSelecionado ? 'selecionado' : ''}" 
                             onclick="workManager.toggleSelecaoUsuario('${usuario.id}')">
                            <i class="fas fa-user${estaSelecionado ? '-check' : ''}"></i>
                            <div class="usuario-info">
                                <strong>${usuario.nome || usuario.id}</strong>
                                <small>${usuario.email || usuario.id}</small>
                            </div>
                            ${estaSelecionado ? '<i class="fas fa-check-circle" style="color: #28a745;"></i>' : ''}
                        </div>
                    `;
                }).join('');
            }
            
            exibirUsuariosParaConvite(termoBusca = '') {
                const container = document.getElementById('usuariosParaConvite');
                if (!container || !this.grupoSelecionado) return;
                
                // Obter membros atuais do grupo
                const grupo = this.grupos.find(g => g.id === this.grupoSelecionado);
                const membrosAtuais = new Set();
                
                if (grupo && grupo.membros) {
                    grupo.membros.forEach(membro => {
                        if (typeof membro === 'string') {
                            membrosAtuais.add(membro);
                        } else if (membro && typeof membro === 'object') {
                            membrosAtuais.add(membro.usuarioId);
                        }
                    });
                }
                
                let usuariosFiltrados = this.usuarios.filter(usuario => 
                    !membrosAtuais.has(usuario.id)
                );
                
                if (termoBusca) {
                    const termo = termoBusca.toLowerCase();
                    usuariosFiltrados = usuariosFiltrados.filter(usuario =>
                        (usuario.nome && usuario.nome.toLowerCase().includes(termo)) ||
                        (usuario.email && usuario.email.toLowerCase().includes(termo)) ||
                        usuario.id.toLowerCase().includes(termo)
                    );
                }
                
                if (usuariosFiltrados.length === 0) {
                    container.innerHTML = `
                        <div class="empty-membros">
                            <i class="fas fa-search"></i>
                            <span>Nenhum usu√°rio dispon√≠vel para convite</span>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = usuariosFiltrados.map(usuario => `
                    <div class="usuario-item" onclick="workManager.selecionarUsuarioParaConvite('${usuario.id}')">
                        <i class="fas fa-user-plus"></i>
                        <div class="usuario-info">
                            <strong>${usuario.nome || usuario.id}</strong>
                            <small>${usuario.email || usuario.id}</small>
                        </div>
                    </div>
                `).join('');
            }
            
            toggleSelecaoUsuario(usuarioId) {
                if (this.membrosSelecionados.has(usuarioId)) {
                    this.membrosSelecionados.delete(usuarioId);
                } else {
                    this.membrosSelecionados.add(usuarioId);
                }
                
                this.exibirUsuarios(document.getElementById('buscarUsuario')?.value || '');
                this.atualizarListaMembrosSelecionados();
            }
            
            atualizarListaMembrosSelecionados() {
                const container = document.getElementById('listaMembrosSelecionados');
                if (!container) return;
                
                if (this.membrosSelecionados.size === 0) {
                    container.innerHTML = `
                        <div class="empty-membros">
                            <i class="fas fa-users"></i>
                            <span>Nenhum membro selecionado</span>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = Array.from(this.membrosSelecionados).map(usuarioId => {
                    const usuario = this.usuarios.find(u => u.id === usuarioId);
                    return `
                        <div class="membro-selecionado-item">
                            <i class="fas fa-user"></i>
                            <span>${usuario ? (usuario.nome || usuario.email || usuario.id) : usuarioId}</span>
                            <button type="button" class="btn-remover" onclick="workManager.removerMembroSelecionado('${usuarioId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            }
            
            removerMembroSelecionado(usuarioId) {
                this.membrosSelecionados.delete(usuarioId);
                this.exibirUsuarios(document.getElementById('buscarUsuario')?.value || '');
                this.atualizarListaMembrosSelecionados();
            }
            
            filtrarUsuarios(termo) {
                this.exibirUsuarios(termo);
            }
            
            filtrarUsuariosParaConvite(termo) {
                this.exibirUsuariosParaConvite(termo);
            }
            
            selecionarUsuarioParaConvite(usuarioId) {
                this.usuarioParaConvitar = usuarioId;
                const input = document.getElementById('buscarUsuarioParaConvite');
                if (input) {
                    const usuario = this.usuarios.find(u => u.id === usuarioId);
                    input.value = usuario ? (usuario.nome || usuario.email || usuarioId) : usuarioId;
                }
            }
            
            // ========== GERENCIAR MEMBROS ==========
            
            async gerenciarMembros(grupoId) {
                this.grupoSelecionado = grupoId;
                const grupo = this.grupos.find(g => g.id === grupoId);
                
                if (!grupo) {
                    this.mostrarAlerta('‚ùå Grupo n√£o encontrado', 'error');
                    return;
                }
                
                // Carregar usu√°rios novamente para garantir dados atualizados
                await this.carregarUsuarios();
                
                const modal = document.getElementById('modalMembros');
                const lista = document.getElementById('membrosAtuaisLista');
                
                // Carregar membros do grupo com informa√ß√µes completas
                let html = '<h3 style="margin-bottom: 15px;">Membros do Grupo</h3>';
                
                if (!grupo.membros || grupo.membros.length === 0) {
                    html += '<p class="text-muted">Nenhum membro encontrado</p>';
                } else {
                    html += '<div class="lista-membros">';
                    
                    for (const membro of grupo.membros) {
                        let usuarioId, permissao, nome, email;
                        
                        if (typeof membro === 'string') {
                            // Formato antigo - apenas usu√°rio ID
                            usuarioId = membro;
                            permissao = 'membro';
                            const usuarioInfo = this.usuarios.find(u => u.id === usuarioId);
                            nome = usuarioInfo?.nome || usuarioId;
                            email = usuarioInfo?.email || usuarioId;
                        } else {
                            // Formato novo - objeto
                            usuarioId = membro.usuarioId;
                            permissao = membro.permissao || 'membro';
                            nome = membro.nome || this.obterNomeUsuario(usuarioId) || usuarioId;
                            email = membro.email || usuarioId;
                        }
                        
                        const isAdmin = permissao === 'admin';
                        const isPending = permissao === 'pendente';
                        const isCurrentUser = usuarioId === this.usuarioAtual.usuario;
                        
                        html += `
                            <div class="membro-item ${isCurrentUser ? 'membro-atual' : ''}">
                                <i class="fas fa-user${isAdmin ? '-shield' : isPending ? '-clock' : ''}"></i>
                                <div class="membro-info">
                                    <strong>${nome}</strong>
                                    <small>${email}</small>
                                </div>
                                <span class="permissao-badge ${permissao}">
                                    ${permissao === 'admin' ? 'Administrador' : 
                                      permissao === 'pendente' ? 'Pendente' : 'Membro'}
                                </span>
                                ${!isCurrentUser && grupo.minhaPermissao === 'admin' ? `
                                    <div class="membro-acoes">
                                        ${!isPending ? `
                                            <button class="btn-icon" onclick="workManager.alterarPermissao('${grupoId}', '${usuarioId}', '${permissao === 'admin' ? 'membro' : 'admin'}')">
                                                <i class="fas fa-${permissao === 'admin' ? 'user' : 'user-shield'}"></i>
                                            </button>
                                        ` : ''}
                                        <button class="btn-icon btn-danger" onclick="workManager.removerMembroGrupo('${grupoId}', '${usuarioId}')">
                                            <i class="fas fa-user-times"></i>
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                }
                
                lista.innerHTML = html;
                
                // Atualizar lista de usu√°rios para convite
                this.exibirUsuariosParaConvite('');
                
                modal.style.display = 'block';
            }
            
            obterNomeUsuario(usuarioId) {
                const usuario = this.usuarios.find(u => u.id === usuarioId);
                return usuario ? (usuario.nome || usuario.email) : null;
            }
            
            fecharModalMembros() {
                const modal = document.getElementById('modalMembros');
                modal.style.display = 'none';
                this.grupoSelecionado = null;
                this.usuarioParaConvitar = null;
            }
            
            async convidarUsuarioSelecionado() {
                if (!this.usuarioParaConvitar) {
                    this.mostrarAlerta('‚ö†Ô∏è Por favor, selecione um usu√°rio primeiro', 'warning');
                    return;
                }
                
                if (!this.grupoSelecionado) {
                    this.mostrarAlerta('‚ùå Nenhum grupo selecionado', 'error');
                    return;
                }
                
                try {
                    const modules = window.firebaseModules;
                    const grupoRef = modules.doc(modules.db, 'grupos', this.grupoSelecionado);
                    const grupoDoc = await modules.getDoc(grupoRef);
                    const grupoData = grupoDoc.data();
                    
                    // Verificar se o usu√°rio j√° est√° no grupo
                    let jaEstaNoGrupo = false;
                    if (grupoData.membros) {
                        for (const membro of grupoData.membros) {
                            if (typeof membro === 'string' && membro === this.usuarioParaConvitar) {
                                jaEstaNoGrupo = true;
                                break;
                            } else if (membro && membro.usuarioId === this.usuarioParaConvitar) {
                                jaEstaNoGrupo = true;
                                break;
                            }
                        }
                    }
                    
                    if (jaEstaNoGrupo) {
                        this.mostrarAlerta('‚ö†Ô∏è Este usu√°rio j√° est√° no grupo', 'warning');
                        return;
                    }
                    
                    // Adicionar usu√°rio como membro pendente
                    await modules.updateDoc(grupoRef, {
                        membros: modules.arrayUnion(this.usuarioParaConvitar), // String simples
                        dataAtualizacao: modules.serverTimestamp()
                    });
                    
                    this.mostrarAlerta('‚úÖ Convite enviado com sucesso!', 'success');
                    
                    // Limpar sele√ß√£o
                    this.usuarioParaConvitar = null;
                    const input = document.getElementById('buscarUsuarioParaConvite');
                    if (input) input.value = '';
                    
                    // Atualizar lista
                    this.exibirUsuariosParaConvite('');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao convidar usu√°rio:', error);
                    this.mostrarAlerta(`‚ùå Erro: ${error.message}`, 'error');
                }
            }
            
            async alterarPermissao(grupoId, usuarioId, novaPermissao) {
                try {
                    const modules = window.firebaseModules;
                    const grupoRef = modules.doc(modules.db, 'grupos', grupoId);
                    const grupoDoc = await modules.getDoc(grupoRef);
                    const grupoData = grupoDoc.data();
                    
                    // Para permiss√µes, precisamos converter para objetos
                    let membrosAtualizados = [];
                    let encontrou = false;
                    
                    if (grupoData.membros) {
                        membrosAtualizados = grupoData.membros.map(membro => {
                            if (typeof membro === 'string' && membro === usuarioId) {
                                encontrou = true;
                                return { 
                                    usuarioId: usuarioId, 
                                    permissao: novaPermissao 
                                };
                            } else if (membro && typeof membro === 'object' && membro.usuarioId === usuarioId) {
                                encontrou = true;
                                return { ...membro, permissao: novaPermissao };
                            }
                            return membro;
                        });
                        
                        // Se n√£o encontrou como objeto, mas estava como string
                        if (!encontrou && grupoData.membros.includes(usuarioId)) {
                            membrosAtualizados = grupoData.membros.map(membro => {
                                if (membro === usuarioId) {
                                    return { 
                                        usuarioId: usuarioId, 
                                        permissao: novaPermissao 
                                    };
                                }
                                return membro;
                            });
                        }
                    }
                    
                    await modules.updateDoc(grupoRef, {
                        membros: membrosAtualizados,
                        dataAtualizacao: modules.serverTimestamp()
                    });
                    
                    this.mostrarAlerta(`‚úÖ Permiss√£o alterada para ${novaPermissao === 'admin' ? 'administrador' : 'membro'}`, 'success');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao alterar permiss√£o:', error);
                    this.mostrarAlerta(`‚ùå Erro: ${error.message}`, 'error');
                }
            }
            
            async removerMembroGrupo(grupoId, usuarioId) {
                this.mostrarConfirmacao(
                    'Remover Membro',
                    'Tem certeza que deseja remover este membro do grupo?',
                    async () => {
                        try {
                            const modules = window.firebaseModules;
                            const grupoRef = modules.doc(modules.db, 'grupos', grupoId);
                            const grupoDoc = await modules.getDoc(grupoRef);
                            const grupoData = grupoDoc.data();
                            
                            // Remover o membro da lista
                            let membrosAtualizados = [];
                            
                            if (grupoData.membros) {
                                membrosAtualizados = grupoData.membros.filter(membro => {
                                    if (typeof membro === 'string') {
                                        return membro !== usuarioId;
                                    } else if (membro && typeof membro === 'object') {
                                        return membro.usuarioId !== usuarioId;
                                    }
                                    return true;
                                });
                            }
                            
                            await modules.updateDoc(grupoRef, {
                                membros: membrosAtualizados,
                                dataAtualizacao: modules.serverTimestamp()
                            });
                            
                            this.mostrarAlerta('‚úÖ Membro removido com sucesso', 'success');
                            
                            // Recarregar a lista de membros
                            this.gerenciarMembros(grupoId);
                            
                        } catch (error) {
                            console.error('‚ùå Erro ao remover membro:', error);
                            this.mostrarAlerta(`‚ùå Erro: ${error.message}`, 'error');
                        }
                    }
                );
            }
            
            // ========== RESPONDER CONVITE ==========
            
            async responderConvite(grupoId, resposta) {
                const acao = resposta === 'aceitar' ? 'aceitar' : 'recusar';
                
                this.mostrarConfirmacao(
                    resposta === 'aceitar' ? 'Aceitar Convite' : 'Recusar Convite',
                    resposta === 'aceitar' 
                        ? 'Tem certeza que deseja aceitar o convite e entrar neste grupo?'
                        : 'Tem certeza que deseja recusar este convite?',
                    async () => {
                        try {
                            const modules = window.firebaseModules;
                            const grupoRef = modules.doc(modules.db, 'grupos', grupoId);
                            const grupoDoc = await modules.getDoc(grupoRef);
                            const grupoData = grupoDoc.data();
                            
                            if (resposta === 'aceitar') {
                                // Converter de pendente para membro
                                let membrosAtualizados = [];
                                
                                if (grupoData.membros) {
                                    membrosAtualizados = grupoData.membros.map(membro => {
                                        if (typeof membro === 'string' && membro === this.usuarioAtual.usuario) {
                                            return { 
                                                usuarioId: this.usuarioAtual.usuario, 
                                                permissao: 'membro'
                                            };
                                        } else if (membro && typeof membro === 'object' && membro.usuarioId === this.usuarioAtual.usuario) {
                                            return { 
                                                ...membro, 
                                                permissao: 'membro'
                                            };
                                        }
                                        return membro;
                                    });
                                    
                                    // Se n√£o encontrou, adicionar como novo membro
                                    if (!membrosAtualizados.some(m => 
                                        (typeof m === 'string' && m === this.usuarioAtual.usuario) ||
                                        (m && typeof m === 'object' && m.usuarioId === this.usuarioAtual.usuario)
                                    )) {
                                        membrosAtualizados.push({ 
                                            usuarioId: this.usuarioAtual.usuario, 
                                            permissao: 'membro'
                                        });
                                    }
                                } else {
                                    membrosAtualizados = [{ 
                                        usuarioId: this.usuarioAtual.usuario, 
                                        permissao: 'membro'
                                    }];
                                }
                                
                                await modules.updateDoc(grupoRef, {
                                    membros: membrosAtualizados,
                                    dataAtualizacao: modules.serverTimestamp()
                                });
                                
                                this.mostrarAlerta('‚úÖ Convite aceito! Bem-vindo ao grupo!', 'success');
                            } else {
                                // Remover o usu√°rio da lista de membros
                                let membrosAtualizados = [];
                                
                                if (grupoData.membros) {
                                    membrosAtualizados = grupoData.membros.filter(membro => {
                                        if (typeof membro === 'string') {
                                            return membro !== this.usuarioAtual.usuario;
                                        } else if (membro && typeof membro === 'object') {
                                            return membro.usuarioId !== this.usuarioAtual.usuario;
                                        }
                                        return true;
                                    });
                                }
                                
                                await modules.updateDoc(grupoRef, {
                                    membros: membrosAtualizados,
                                    dataAtualizacao: modules.serverTimestamp()
                                });
                                
                                this.mostrarAlerta('‚úÖ Convite recusado', 'success');
                            }
                            
                        } catch (error) {
                            console.error(`‚ùå Erro ao ${resposta} convite:`, error);
                            this.mostrarAlerta(`‚ùå Erro: ${error.message}`, 'error');
                        }
                    }
                );
            }
            
            // ========== SAIR DO GRUPO ==========
            
            async sairGrupo(grupoId) {
                this.mostrarConfirmacao(
                    'Sair do Grupo',
                    'Tem certeza que deseja sair deste grupo?',
                    async () => {
                        try {
                            const modules = window.firebaseModules;
                            const grupoRef = modules.doc(modules.db, 'grupos', grupoId);
                            const grupoDoc = await modules.getDoc(grupoRef);
                            const grupoData = grupoDoc.data();
                            
                            // Remover o usu√°rio da lista de membros
                            let membrosAtualizados = [];
                            
                            if (grupoData.membros) {
                                membrosAtualizados = grupoData.membros.filter(membro => {
                                    if (typeof membro === 'string') {
                                        return membro !== this.usuarioAtual.usuario;
                                    } else if (membro && typeof membro === 'object') {
                                        return membro.usuarioId !== this.usuarioAtual.usuario;
                                    }
                                    return true;
                                });
                            }
                            
                            // Se n√£o houver mais membros, excluir o grupo
                            if (membrosAtualizados.length === 0) {
                                await modules.deleteDoc(grupoRef);
                                this.mostrarAlerta('‚úÖ Grupo exclu√≠do (sem membros)', 'info');
                            } else {
                                await modules.updateDoc(grupoRef, {
                                    membros: membrosAtualizados,
                                    dataAtualizacao: modules.serverTimestamp()
                                });
                                this.mostrarAlerta('‚úÖ Voc√™ saiu do grupo', 'success');
                            }
                            
                        } catch (error) {
                            console.error('‚ùå Erro ao sair do grupo:', error);
                            this.mostrarAlerta(`‚ùå Erro: ${error.message}`, 'error');
                        }
                    }
                );
            }
            
            // ========== EXCLUIR GRUPO ==========
            
            async excluirGrupo(grupoId) {
                this.mostrarConfirmacao(
                    'Excluir Grupo',
                    'Tem certeza que deseja excluir este grupo? Esta a√ß√£o n√£o pode ser desfeita.',
                    async () => {
                        try {
                            const modules = window.firebaseModules;
                            const grupoRef = modules.doc(modules.db, 'grupos', grupoId);
                            await modules.deleteDoc(grupoRef);
                            
                            this.mostrarAlerta('‚úÖ Grupo exclu√≠do com sucesso', 'success');
                            
                        } catch (error) {
                            console.error('‚ùå Erro ao excluir grupo:', error);
                            this.mostrarAlerta(`‚ùå Erro: ${error.message}`, 'error');
                        }
                    }
                );
            }
            
            // ========== MODAL DE CONFIRMA√á√ÉO ==========
            
            mostrarConfirmacao(titulo, mensagem, callback) {
                this.acaoConfirmacao = callback;
                
                document.getElementById('confirmacaoTitulo').textContent = titulo;
                document.getElementById('confirmacaoMensagem').textContent = mensagem;
                
                const modal = document.getElementById('modalConfirmacao');
                modal.style.display = 'block';
            }
            
            fecharModalConfirmacao() {
                const modal = document.getElementById('modalConfirmacao');
                modal.style.display = 'none';
                this.acaoConfirmacao = null;
            }
            
            confirmarAcao() {
                if (this.acaoConfirmacao) {
                    this.acaoConfirmacao();
                }
                this.fecharModalConfirmacao();
            }
            
            // ========== VISUALIZAR GRUPO ==========
            
            verDetalhesGrupo(grupoId) {
                const grupo = this.grupos.find(g => g.id === grupoId);
                if (!grupo) return;
                
                // Obter informa√ß√µes dos membros
                let membrosInfo = '';
                if (grupo.membros && Array.isArray(grupo.membros)) {
                    membrosInfo = '<h4>Membros:</h4><ul style="list-style: none; padding-left: 0;">';
                    grupo.membros.forEach((membro, index) => {
                        if (typeof membro === 'string') {
                            const usuario = this.usuarios.find(u => u.id === membro);
                            membrosInfo += `<li>${index + 1}. ${usuario ? (usuario.nome || usuario.email || membro) : membro}</li>`;
                        } else if (membro && typeof membro === 'object') {
                            const usuario = this.usuarios.find(u => u.id === membro.usuarioId);
                            const nome = membro.nome || (usuario ? (usuario.nome || usuario.email) : membro.usuarioId);
                            membrosInfo += `<li>${index + 1}. ${nome} (${membro.permissao})</li>`;
                        }
                    });
                    membrosInfo += '</ul>';
                }
                
                const detalhes = `
                    <div style="padding: 20px;">
                        <h2 style="color: ${grupo.cor || '#4a6fa5'}; margin-top: 0;">${grupo.nome}</h2>
                        <p><strong>Descri√ß√£o:</strong><br>${grupo.descricao || 'N√£o informada'}</p>
                        <p><strong>Criado em:</strong> ${this.formatarData(grupo.dataCriacao)}</p>
                        <p><strong>Criador:</strong> ${grupo.criadorNome || grupo.criador || 'N√£o informado'}</p>
                        ${membrosInfo}
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="workManager.fecharDetalhes()" class="btn btn-outline">
                                Fechar
                            </button>
                        </div>
                    </div>
                `;
                
                // Criar modal de detalhes
                const modalDetalhes = document.createElement('div');
                modalDetalhes.className = 'modal';
                modalDetalhes.id = 'modalDetalhes';
                modalDetalhes.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2>Detalhes do Grupo</h2>
                            <button class="close" onclick="workManager.fecharDetalhes()">&times;</button>
                        </div>
                        ${detalhes}
                    </div>
                `;
                
                document.body.appendChild(modalDetalhes);
                modalDetalhes.style.display = 'block';
                
                // Fechar ao clicar fora
                modalDetalhes.onclick = (e) => {
                    if (e.target === modalDetalhes) {
                        this.fecharDetalhes();
                    }
                };
            }
            
            fecharDetalhes() {
                const modal = document.getElementById('modalDetalhes');
                if (modal) {
                    modal.style.display = 'none';
                    setTimeout(() => {
                        if (modal.parentNode) {
                            document.body.removeChild(modal);
                        }
                    }, 300);
                }
            }
            
            // ========== ALERTAS ==========
            
            mostrarAlerta(mensagem, tipo = 'info') {
                const alerta = document.createElement('div');
                alerta.className = `alerta alerta-${tipo}`;
                alerta.innerHTML = `
                    <i class="fas fa-${tipo === 'success' ? 'check-circle' : 
                                       tipo === 'warning' ? 'exclamation-triangle' : 
                                       tipo === 'error' ? 'times-circle' : 'info-circle'}"></i>
                    <span>${mensagem}</span>
                `;
                
                alerta.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${tipo === 'success' ? '#d4edda' : 
                                 tipo === 'warning' ? '#fff3cd' : 
                                 tipo === 'error' ? '#f8d7da' : '#d1ecf1'};
                    color: ${tipo === 'success' ? '#155724' : 
                             tipo === 'warning' ? '#856404' : 
                             tipo === 'error' ? '#721c24' : '#0c5460'};
                    padding: 15px 20px;
                    border-radius: 8px;
                    border: 1px solid ${tipo === 'success' ? '#c3e6cb' : 
                                       tipo === 'warning' ? '#ffeaa7' : 
                                       tipo === 'error' ? '#f5c6cb' : '#bee5eb'};
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    animation: slideIn 0.3s ease;
                `;
                
                document.body.appendChild(alerta);
                
                setTimeout(() => {
                    alerta.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (alerta.parentNode) {
                            document.body.removeChild(alerta);
                        }
                    }, 300);
                }, 5000);
            }
            
            // ========== FUN√á√ïES PARA EDI√á√ÉO ==========
            
            async editarGrupo(grupoId) {
                this.abrirModalGrupo(grupoId);
            }
        }
        
        // Criar inst√¢ncia global
        const workManager = new WorkManager();
        
        // Inicializar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                workManager.init();
            });
        } else {
            workManager.init();
        }
        
        // Expor fun√ß√µes globais
        window.workManager = workManager;
        window.abrirModalGrupo = (grupoId) => workManager.abrirModalGrupo(grupoId);
        window.fecharModalGrupo = () => workManager.fecharModalGrupo();
        window.fecharModalMembros = () => workManager.fecharModalMembros();
        window.fecharModalConfirmacao = () => workManager.fecharModalConfirmacao();
        window.salvarGrupo = () => workManager.salvarGrupo();
        window.adicionarMembro = () => workManager.adicionarMembro();
        window.convidarMembro = () => workManager.convidarUsuarioSelecionado();
        window.confirmarAcao = () => workManager.confirmarAcao();
        window.carregarUsuarios = () => workManager.carregarUsuarios().then(() => workManager.exibirUsuarios());
        window.filtrarUsuarios = (termo) => workManager.filtrarUsuarios(termo);
        window.filtrarUsuariosParaConvite = (termo) => workManager.filtrarUsuariosParaConvite(termo);
        
        window.filtrarGrupos = (filtro) => {
            workManager.filtroAtual = filtro;
            workManager.atualizarInterfaceGrupos();
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
        };
        
        // Fechar modais ao clicar fora
        window.onclick = function(event) {
            const modals = ['modalGrupo', 'modalMembros', 'modalConfirmacao'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target == modal) {
                    if (modalId === 'modalGrupo') workManager.fecharModalGrupo();
                    else if (modalId === 'modalMembros') workManager.fecharModalMembros();
                    else if (modalId === 'modalConfirmacao') workManager.fecharModalConfirmacao();
                }
            });
        };
        
        // Permitir submit do formul√°rio com Enter
        document.getElementById('formGrupo')?.addEventListener('submit', function(e) {
            e.preventDefault();
            workManager.salvarGrupo();
        });
        
        // CSS adicional
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            @keyframes modalSlideIn {
                from { transform: translateY(-50px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
            }
            
            .modal-content {
                background-color: #fff;
                margin: 5% auto;
                padding: 0;
                border-radius: 12px;
                width: 90%;
                max-width: 600px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                animation: modalSlideIn 0.3s ease;
            }
            
            .modal-header {
                padding: 20px 30px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 12px 12px 0 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .modal-header h2 {
                margin: 0;
                font-size: 1.5rem;
            }
            
            .close {
                background: none;
                border: none;
                color: white;
                font-size: 28px;
                cursor: pointer;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background-color 0.3s;
            }
            
            .close:hover {
                background-color: rgba(255,255,255,0.2);
            }
            
            .modal-body {
                padding: 30px;
                max-height: 70vh;
                overflow-y: auto;
            }
            
            .modal-footer {
                padding: 20px 30px;
                background-color: #f8f9fa;
                border-top: 1px solid #e9ecef;
                border-radius: 0 0 12px 12px;
                display: flex;
                justify-content: flex-end;
                gap: 10px;
            }
            
            .form-group {
                margin-bottom: 25px;
            }
            
            .form-control {
                width: 100%;
                padding: 12px 15px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                font-size: 14px;
                transition: border-color 0.3s;
                box-sizing: border-box;
            }
            
            .form-control:focus {
                border-color: #667eea;
                outline: none;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            
            .input-group {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .usuarios-lista {
                background-color: #f8f9fa;
                border-radius: 8px;
                padding: 15px;
                margin-top: 10px;
            }
            
            .usuario-item {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px;
                background-color: white;
                border-radius: 6px;
                margin-bottom: 8px;
                border: 1px solid #e9ecef;
                cursor: pointer;
                transition: all 0.3s;
            }
            
            .usuario-item:hover {
                background-color: #f0f2ff;
                border-color: #667eea;
            }
            
            .usuario-item.selecionado {
                background-color: #e8f4fd;
                border-color: #b3d7ff;
            }
            
            .usuario-info {
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            
            .usuario-info small {
                color: #666;
                font-size: 12px;
            }
            
            .membros-selecionados {
                background-color: #f8f9fa;
                border-radius: 8px;
                padding: 15px;
                margin-top: 15px;
            }
            
            .membro-selecionado-item {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 8px;
                background-color: white;
                border-radius: 6px;
                margin-bottom: 6px;
                border: 1px solid #e9ecef;
            }
            
            .lista-membros {
                margin-top: 15px;
            }
            
            .membro-item {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px;
                background-color: white;
                border-radius: 6px;
                margin-bottom: 8px;
                border: 1px solid #e9ecef;
            }
            
            .membro-atual {
                background-color: #e8f4fd;
                border-color: #b3d7ff;
            }
            
            .permissao-badge {
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
                white-space: nowrap;
            }
            
            .permissao-badge.admin {
                background-color: #d4edda;
                color: #155724;
            }
            
            .permissao-badge.membro {
                background-color: #d1ecf1;
                color: #0c5460;
            }
            
            .permissao-badge.pendente {
                background-color: #fff3cd;
                color: #856404;
            }
            
            .membro-acoes {
                display: flex;
                gap: 5px;
            }
            
            .btn-icon {
                background: none;
                border: none;
                cursor: pointer;
                padding: 5px;
                border-radius: 4px;
                color: #667eea;
                font-size: 14px;
            }
            
            .btn-icon:hover {
                background-color: #f0f2ff;
            }
            
            .btn-icon.btn-danger {
                color: #dc3545;
            }
            
            .btn-icon.btn-danger:hover {
                background-color: #f8d7da;
            }
            
            .btn-remover {
                background: none;
                border: none;
                color: #dc3545;
                cursor: pointer;
                padding: 5px;
                border-radius: 4px;
                transition: background-color 0.3s;
                font-size: 12px;
            }
            
            .btn-remover:hover {
                background-color: #f8d7da;
            }
            
            .btn {
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.3s;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }
            
            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }
            
            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }
            
            .btn-outline {
                background: transparent;
                color: #667eea;
                border: 2px solid #667eea;
            }
            
            .btn-outline:hover {
                background: #667eea;
                color: white;
            }
            
            .btn-sm {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .btn-success {
                background-color: #28a745;
                color: white;
            }
            
            .btn-warning {
                background-color: #ffc107;
                color: #212529;
            }
            
            .btn-danger {
                background-color: #dc3545;
                color: white;
            }
            
            .text-muted {
                color: #6c757d !important;
                font-size: 12px;
                margin-top: 5px;
            }
            
            .empty-membros {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 20px;
                color: #6c757d;
                text-align: center;
            }
            
            .empty-membros i {
                font-size: 2rem;
                margin-bottom: 10px;
                opacity: 0.5;
            }
            
            @media (max-width: 768px) {
                .modal-content {
                    margin: 10% auto;
                    width: 95%;
                }
                
                .modal-header {
                    padding: 15px 20px;
                }
                
                .modal-body {
                    padding: 20px;
                }
                
                .modal-footer {
                    padding: 15px 20px;
                    flex-direction: column;
                }
                
                .modal-footer .btn {
                    width: 100%;
                    margin-bottom: 10px;
                }
                
                .modal-footer .btn:last-child {
                    margin-bottom: 0;
                }
                
                .input-group {
                    flex-direction: column;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
