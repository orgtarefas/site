<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat OrgTarefas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <div id="chat-screen" class="screen">
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="header-left">
                        <h3><i class="fas fa-comments"></i> Mensagens</h3>
                        <span class="app-name">OrgTarefas</span>
                    </div>
                    <button id="back-btn" class="btn-logout" onclick="window.location.href='index.html'">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                
                <!-- Seletor de Usu√°rio -->
                <div class="user-selector-container">
                    <div class="section-header">
                        <h4><i class="fas fa-user"></i> Eu sou</h4>
                    </div>
                    <div class="user-selector">
                        <select id="user-select" class="user-select-dropdown">
                            <option value="">Selecione seu usu√°rio...</option>
                        </select>
                        <button id="confirm-user-btn" class="btn-confirm-user" disabled>
                            <i class="fas fa-check"></i> Entrar no Chat
                        </button>
                    </div>
                    <div id="login-status" class="login-status"></div>
                </div>
                
                <!-- √Årea do Usu√°rio Logado (hidden por padr√£o) -->
                <div class="user-info hidden" id="logged-user-area">
                    <img id="user-avatar" src="" alt="Avatar" class="user-avatar">
                    <div class="user-details">
                        <span id="current-user-name" class="user-name">Carregando...</span>
                        <div class="user-info-bottom">
                            <span id="current-user-login" class="user-login"></span>
                            <span id="current-user-perfil" class="user-perfil"></span>
                            <span id="online-status" class="status-online">‚óè online</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- √Årea principal -->
            <div class="main-content">
                <div class="chat-header">
                    <div class="chat-info-default">
                        <div class="default-icon">
                            <i class="fas fa-comment-dots"></i>
                        </div>
                        <div class="default-content">
                            <h2>Bem-vindo ao Chat</h2>
                            <p>Selecione seu usu√°rio para come√ßar</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURA√á√ÉO FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAs0Ke4IBfBWDrfH0AXaOhCEjtfpPtR_Vg",
            authDomain: "orgtarefas-85358.firebaseapp.com",
            projectId: "orgtarefas-85358",
            storageBucket: "orgtarefas-85358.firebasestorage.app",
            messagingSenderId: "1023569488575",
            appId: "1:1023569488575:web:18f9e201115a1a92ccb40a"
        };

        const chatFirebaseConfig = {
            apiKey: "AIzaSyAYROPCh-558mNXPrO7onAXFvfBe13q5Js",
            authDomain: "orgtarefas-chat.firebaseapp.com",
            databaseURL: "https://orgtarefas-chat-default-rtdb.firebaseio.com",
            projectId: "orgtarefas-chat",
            storageBucket: "orgtarefas-chat.firebasestorage.app",
            messagingSenderId: "380919096800",
            appId: "1:380919096800:web:7b54e7e341c9266c207785"
        };

        // ========== INICIALIZAR APPS ==========
        let db, chatDb;
        
        try {
            console.log('üöÄ Inicializando Firebase...');
            const mainApp = firebase.initializeApp(firebaseConfig, 'mainApp');
            const chatApp = firebase.initializeApp(chatFirebaseConfig, 'chatApp');
            
            db = firebase.firestore(mainApp);
            chatDb = firebase.database();
            
            console.log('‚úÖ Firebase inicializado com sucesso');
        } catch (error) {
            console.error('‚ùå Erro ao inicializar Firebase:', error);
            showStatus('Erro ao conectar: ' + error.message, 'error');
        }

        // ========== ELEMENTOS DOM ==========
        const userSelect = document.getElementById('user-select');
        const confirmUserBtn = document.getElementById('confirm-user-btn');
        const loginStatus = document.getElementById('login-status');

        // ========== INICIALIZA√á√ÉO ==========
        async function init() {
            console.log('üöÄ Inicializando chat...');
            setupEventListeners();
            await loadUsersFromFirestore();
        }

        // ========== CARREGAR USU√ÅRIOS DO FIRESTORE ==========
        async function loadUsersFromFirestore() {
            try {
                console.log('üîç Buscando usu√°rios reais...');
                showStatus('Buscando usu√°rios...', 'info');
                
                // M√©todo 1: Buscar TODOS os documentos da cole√ß√£o
                const querySnapshot = await db.collection('LOGINS_ORGTAREFAS').get();
                console.log(`üìÑ Total de documentos: ${querySnapshot.size}`);
                
                let usuariosReais = [];
                
                querySnapshot.forEach(doc => {
                    const docId = doc.id;
                    const dados = doc.data();
                    
                    console.log(`\nüìã Documento: ${docId}`);
                    console.log('üìä Dados:', dados);
                    
                    // Verificar TODOS os campos do documento
                    Object.keys(dados).forEach(campo => {
                        const valor = dados[campo];
                        
                        if (typeof valor === 'object' && valor !== null) {
                            console.log(`  üîç Campo: ${campo}`, valor);
                            
                            // Se tem login e displayName, √© um usu√°rio
                            if (valor.login && valor.displayName) {
                                console.log(`  ‚úÖ ENCONTROU USU√ÅRIO: ${valor.login}`);
                                
                                const usuario = {
                                    uid: `${docId}_${campo}`,
                                    docId: docId,
                                    campo: campo,
                                    login: valor.login,
                                    nome: valor.displayName,
                                    perfil: valor.perfil || 'Usu√°rio',
                                    email: valor.email || '',
                                    status: valor.status || 'Ativo',
                                    senha: valor.senha || ''
                                };
                                
                                usuariosReais.push(usuario);
                                console.log(`  üë§ Adicionado: ${usuario.nome}`);
                            }
                        }
                    });
                });
                
                console.log(`\nüéØ Total de usu√°rios reais encontrados: ${usuariosReais.length}`);
                
                if (usuariosReais.length > 0) {
                    // Ordenar por nome
                    usuariosReais.sort((a, b) => a.nome.localeCompare(b.nome));
                    
                    // Adicionar ao select
                    usuariosReais.forEach(usuario => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify(usuario);
                        option.textContent = `${usuario.nome} (${usuario.login}) - ${usuario.perfil}`;
                        userSelect.appendChild(option);
                    });
                    
                    showStatus(`${usuariosReais.length} usu√°rio(s) carregado(s)`, 'success');
                } else {
                    // M√©todo 2: Se n√£o encontrou na estrutura interna, tentar no n√≠vel do documento
                    console.log('üîç Tentando m√©todo alternativo...');
                    
                    querySnapshot.forEach(doc => {
                        const dados = doc.data();
                        
                        // Se o documento tem login direto
                        if (dados.login && dados.displayName) {
                            console.log(`‚úÖ Documento tem usu√°rio direto: ${dados.login}`);
                            
                            const usuario = {
                                uid: doc.id,
                                docId: doc.id,
                                campo: 'main',
                                login: dados.login,
                                nome: dados.displayName,
                                perfil: dados.perfil || 'Usu√°rio',
                                email: dados.email || '',
                                status: dados.status || 'Ativo',
                                senha: dados.senha || ''
                            };
                            
                            usuariosReais.push(usuario);
                        }
                    });
                    
                    if (usuariosReais.length > 0) {
                        usuariosReais.forEach(usuario => {
                            const option = document.createElement('option');
                            option.value = JSON.stringify(usuario);
                            option.textContent = `${usuario.nome} (${usuario.login})`;
                            userSelect.appendChild(option);
                        });
                        
                        showStatus(`${usuariosReais.length} usu√°rio(s) carregado(s)`, 'success');
                    } else {
                        showStatus('Nenhum usu√°rio encontrado. Verifique a estrutura dos dados.', 'error');
                        console.log('‚ùå Estrutura dos documentos encontrados:');
                        querySnapshot.forEach(doc => {
                            console.log(`üìã ${doc.id}:`, doc.data());
                        });
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
                showStatus('Erro: ' + error.message, 'error');
            }
        }

        // ========== FUN√á√ïES AUXILIARES ==========
        function showStatus(message, type) {
            if (!loginStatus) return;
            
            loginStatus.textContent = message;
            loginStatus.className = 'login-status';
            
            switch(type) {
                case 'error':
                    loginStatus.style.color = '#f44336';
                    loginStatus.style.backgroundColor = '#ffebee';
                    break;
                case 'success':
                    loginStatus.style.color = '#4caf50';
                    loginStatus.style.backgroundColor = '#e8f5e8';
                    break;
                default:
                    loginStatus.style.color = '#2196f3';
                    loginStatus.style.backgroundColor = '#e3f2fd';
            }
            
            loginStatus.style.display = 'block';
            
            // Limpar ap√≥s 5 segundos se for sucesso/info
            if (type !== 'error') {
                setTimeout(() => {
                    loginStatus.style.display = 'none';
                }, 5000);
            }
        }

        function setupEventListeners() {
            userSelect.addEventListener('change', (e) => {
                confirmUserBtn.disabled = !e.target.value;
            });
            
            confirmUserBtn.addEventListener('click', () => {
                if (!userSelect.value) return;
                
                try {
                    const userData = JSON.parse(userSelect.value);
                    console.log('üë§ Usu√°rio selecionado:', userData);
                    showStatus(`Bem-vindo, ${userData.nome}!`, 'success');
                    
                    // Aqui voc√™ pode continuar com a l√≥gica do chat
                    // Ex: setupChatUser(userData);
                    
                } catch (error) {
                    console.error('Erro ao processar usu√°rio:', error);
                    showStatus('Erro ao selecionar usu√°rio', 'error');
                }
            });
        }

        // ========== INICIAR APP ==========
        document.addEventListener('DOMContentLoaded', init);
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            color: #333;
        }
        
        .container {
            width: 100%;
            height: 100%;
        }
        
        .screen {
            width: 100%;
            height: 100%;
            display: flex;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .sidebar-header h3 {
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .app-name {
            font-size: 12px;
            color: #667eea;
            background: #f0f2f5;
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .btn-logout {
            background: #f0f2f5;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            background: #ffebee;
            color: #f44336;
            transform: rotate(-90deg);
        }
        
        .user-selector-container {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .section-header {
            margin-bottom: 15px;
        }
        
        .section-header h4 {
            font-size: 14px;
            color: #666;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .user-select-dropdown {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            background: #f8f9fa;
            color: #333;
        }
        
        .user-select-dropdown:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }
        
        .btn-confirm-user {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-confirm-user:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-confirm-user:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .login-status {
            margin-top: 10px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #ddd;
        }
        
        .chat-info-default {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .default-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        .default-content h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .default-content p {
            color: #666;
            font-size: 14px;
        }
    </style>
</body>
</html>
