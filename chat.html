<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat OrgTarefas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div id="chat-screen" class="screen">
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="header-left">
                        <h3><i class="fas fa-comments"></i> Mensagens</h3>
                        <span class="app-name">OrgTarefas</span>
                    </div>
                    <button id="back-btn" class="btn-logout" onclick="window.location.href='index.html'">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                
                <!-- Seletor de Usu√°rio (aparece apenas se n√£o fez auto-login) -->
                <div class="user-selector-container" id="user-selector-container">
                    <div class="section-header">
                        <h4><i class="fas fa-user"></i> Eu sou</h4>
                    </div>
                    <div class="user-selector">
                        <select id="user-select" class="user-select-dropdown">
                            <option value="">Selecione seu usu√°rio...</option>
                        </select>
                        <button id="confirm-user-btn" class="btn-confirm-user" disabled>
                            <i class="fas fa-check"></i> Entrar no Chat
                        </button>
                    </div>
                    <div id="login-status" class="login-status"></div>
                </div>
                
                <!-- √Årea do Usu√°rio Logado (aparece ap√≥s login) -->
                <div class="user-info hidden" id="logged-user-area">
                    <img id="user-avatar" src="" alt="Avatar" class="user-avatar">
                    <div class="user-details">
                        <span id="current-user-name" class="user-name">Carregando...</span>
                        <div class="user-info-bottom">
                            <span id="current-user-login" class="user-login"></span>
                            <span id="current-user-perfil" class="user-perfil"></span>
                            <span id="online-status" class="status-online">‚óè online</span>
                        </div>
                    </div>
                </div>
                
                <!-- Se√ß√£o: Usu√°rios Online (aparece ap√≥s login) -->
                <div class="section-header hidden" id="online-users-header">
                    <h4><i class="fas fa-user-check"></i> Colegas Online</h4>
                    <span id="online-count" class="count-badge">0</span>
                </div>
                <div class="online-users hidden" id="online-users-list">
                    <div class="loading-online">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Buscando colegas online...</p>
                    </div>
                </div>
                
                <!-- Se√ß√£o: Conversas (aparece ap√≥s login) -->
                <div class="section-header hidden" id="conversations-header">
                    <h4><i class="fas fa-inbox"></i> Conversas</h4>
                    <span id="conversations-count" class="count-badge">0</span>
                </div>
                <div class="conversations-list hidden" id="conversations-list">
                    <div class="loading-conversations">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Carregando suas conversas...</p>
                    </div>
                </div>
            </div>
            
            <!-- √Årea principal do chat -->
            <div class="main-content">
                <!-- Cabe√ßalho da conversa -->
                <div class="chat-header" id="chat-header">
                    <div class="chat-info-default" id="chat-info-default">
                        <div class="default-icon">
                            <i class="fas fa-comment-dots"></i>
                        </div>
                        <div class="default-content">
                            <h2>Bem-vindo ao Chat</h2>
                            <p>Selecione um colega online para conversar</p>
                        </div>
                    </div>
                    
                    <div class="chat-info-active hidden" id="chat-info-active">
                        <div class="active-user">
                            <img id="active-user-avatar" src="" alt="Avatar" class="active-avatar">
                            <div class="active-user-info">
                                <h2 id="active-user-name">Nome do Usu√°rio</h2>
                                <div class="active-user-details">
                                    <span id="active-user-perfil" class="user-perfil-small"></span>
                                    <span id="active-user-status" class="user-status">‚óè online</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- √Årea de mensagens -->
                <div class="messages-area">
                    <div class="messages-container" id="messages-container">
                        <div class="welcome-screen" id="welcome-screen">
                            <div class="welcome-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="welcome-content">
                                <h3>Chat em Tempo Real</h3>
                                <p>Conecte-se com seus colegas de trabalho</p>
                                <div class="welcome-features">
                                    <div class="feature">
                                        <i class="fas fa-shield-alt"></i>
                                        <span>Seguro e privado</span>
                                    </div>
                                    <div class="feature">
                                        <i class="fas fa-history"></i>
                                        <span>Hist√≥rico salvo</span>
                                    </div>
                                    <div class="feature">
                                        <i class="fas fa-bolt"></i>
                                        <span>Tempo real</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Input de mensagem (aparece quando tem conversa ativa) -->
                    <div class="message-input-area hidden" id="message-input-area">
                        <input type="text" id="message-input" placeholder="Digite sua mensagem..." autocomplete="off">
                        <button id="send-btn" class="btn-send">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // ========== CONFIGURA√á√ÉO FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAs0Ke4IBfBWDrfH0AXaOhCEjtfpPtR_Vg",
            authDomain: "orgtarefas-85358.firebaseapp.com",
            projectId: "orgtarefas-85358",
            storageBucket: "orgtarefas-85358.firebasestorage.app",
            messagingSenderId: "1023569488575",
            appId: "1:1023569488575:web:18f9e201115a1a92ccb40a"
        };

        const chatFirebaseConfig = {
            apiKey: "AIzaSyAYROPCh-558mNXPrO7onAXFvfBe13q5Js",
            authDomain: "orgtarefas-chat.firebaseapp.com",
            databaseURL: "https://orgtarefas-chat-default-rtdb.firebaseio.com",
            projectId: "orgtarefas-chat",
            storageBucket: "orgtarefas-chat.firebasestorage.app",
            messagingSenderId: "380919096800",
            appId: "1:380919096800:web:7b54e7e341c9266c207785"
        };

        // ========== VARI√ÅVEIS GLOBAIS ==========
        let db, chatDb, currentUser = null;
        let currentConversation = null;
        let conversationsRef = null;
        let usersRef = null;
        let messagesRef = null;
        let allUsers = [];
        let onlineUsersCache = {};

        // ========== INICIALIZAR FIREBASE ==========
        function initializeFirebase() {
            try {
                console.log('üöÄ Inicializando Firebase...');
                
                const mainApp = firebase.initializeApp(firebaseConfig);
                const chatApp = firebase.initializeApp(chatFirebaseConfig, 'chatApp');
                
                db = firebase.firestore(mainApp);
                chatDb = firebase.database(chatApp);
                
                console.log('‚úÖ Firebase inicializado');
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Firebase:', error);
                showStatus('Erro ao conectar com o servidor', 'error');
                return false;
            }
        }

        // ========== ELEMENTOS DOM ==========
        let userSelect, confirmUserBtn, loginStatus;

        // ========== INICIALIZA√á√ÉO ==========
        async function init() {
            console.log('üöÄ Inicializando chat...');
            
            if (!initializeFirebase()) return;
            
            setupDOM();
            setupEventListeners();
            
            // Tentar auto-login
            const autoLogged = await tryAutoLogin();
            
            // Se n√£o fez auto-login, carregar lista para sele√ß√£o
            if (!autoLogged) {
                await loadUsersForSelection();
            }
        }

        // ========== CONFIGURAR ELEMENTOS DOM ==========
        function setupDOM() {
            userSelect = document.getElementById('user-select');
            confirmUserBtn = document.getElementById('confirm-user-btn');
            loginStatus = document.getElementById('login-status');
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            if (userSelect) {
                userSelect.addEventListener('change', (e) => {
                    if (confirmUserBtn) confirmUserBtn.disabled = !e.target.value;
                });
            }
            
            if (confirmUserBtn) {
                confirmUserBtn.addEventListener('click', handleUserSelection);
            }
            
            // Listener para envio de mensagem
            const sendBtn = document.getElementById('send-btn');
            const messageInput = document.getElementById('message-input');
            
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        }

        // ========== ATUALIZAR STATUS ONLINE NO FIRESTORE ==========
        async function updateOnlineStatusInFirestore(userId, isOnline) {
            try {
                // Encontrar o usu√°rio
                const user = allUsers.find(u => u.uid === userId) || 
                            (await getAllUsersFromFirestore()).find(u => u.uid === userId);
                
                if (user) {
                    const docRef = db.collection('LOGINS_ORGTAREFAS').doc(user.docId);
                    
                    // Atualizar o campo isOnline dentro do userX_uid
                    const updateData = {};
                    updateData[`${user.campo}.isOnline`] = isOnline;
                    
                    await docRef.update(updateData);
                    console.log(`‚úÖ Status ${isOnline ? 'online' : 'offline'} atualizado no Firestore para ${user.login}`);
                }
            } catch (error) {
                console.error('‚ùå Erro ao atualizar status no Firestore:', error);
            }
        }
        
        // ========== TENTAR AUTO-LOGIN ==========
        async function tryAutoLogin() {
            try {
                const usuarioLogadoStr = localStorage.getItem('usuarioLogado');
                if (usuarioLogadoStr) {
                    const usuarioLogado = JSON.parse(usuarioLogadoStr);
                    console.log('üë§ Tentando auto-login para:', usuarioLogado.usuario);
                    
                    // Buscar em TODOS os usu√°rios do Firestore
                    const allFirestoreUsers = await getAllUsersFromFirestore();
                    const foundUser = allFirestoreUsers.find(u => u.login === usuarioLogado.usuario);
                    
                    if (foundUser) {
                        console.log('‚úÖ Auto-login bem-sucedido para:', foundUser.login);
                        currentUser = foundUser;
                        return true;
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro no auto-login:', error);
            }
            return false;
        }

        // ========== STATUS ONLINE ==========
        async function fixOnlineStatus() {
            try {
                console.log('üîß Corrigindo status online...');
                
                // 1. Buscar todos os usu√°rios do Firestore
                const firestoreUsers = await getAllUsersFromFirestore();
                
                // 2. Buscar todos os usu√°rios do RTDB
                const rtdbSnapshot = await chatDb.ref('users').once('value');
                const rtdbUsers = rtdbSnapshot.val() || {};
                
                // 3. Para cada usu√°rio online no Firestore, garantir que est√° online no RTDB
                for (const fsUser of firestoreUsers) {
                    if (fsUser.isOnline === true) {
                        const rtdbRef = chatDb.ref(`users/${fsUser.uid}`);
                        const snapshot = await rtdbRef.once('value');
                        
                        if (snapshot.exists()) {
                            const rtdbUser = snapshot.val();
                            
                            // Se est√° offline no RTDB mas online no Firestore, corrigir
                            if (rtdbUser.isOnline === false) {
                                console.log(`üîÑ Corrigindo ${fsUser.login}: Firestore=true, RTDB=false -> true`);
                                
                                await rtdbRef.update({
                                    isOnline: true,
                                    lastSeen: Date.now(),
                                    correctedAt: Date.now(),
                                    firestoreStatus: true
                                });
                            }
                        } else {
                            // Usu√°rio n√£o existe no RTDB, criar
                            console.log(`‚ûï Criando ${fsUser.login} no RTDB (online: true)`);
                            
                            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(fsUser.nome)}&background=667eea&color=fff`;
                            
                            await rtdbRef.set({
                                uid: fsUser.uid,
                                login: fsUser.login,
                                nome: fsUser.nome,
                                perfil: fsUser.perfil,
                                avatarUrl: avatarUrl,
                                isOnline: true,
                                lastSeen: Date.now(),
                                createdFromFirestore: true
                            });
                        }
                    }
                }
                
                console.log('‚úÖ Status online corrigido');
                
            } catch (error) {
                console.error('‚ùå Erro ao corrigir status online:', error);
            }
        }

        

        // ========== CARREGAR USU√ÅRIOS PARA SELE√á√ÉO ==========
        async function loadUsersForSelection() {
            try {
                showStatus('Carregando usu√°rios...', 'info');
                
                const querySnapshot = await db.collection('usuarios').get();
                console.log(`üìÑ Usu√°rios encontrados: ${querySnapshot.size}`);
                
                querySnapshot.forEach(doc => {
                    const dados = doc.data();
                    
                    if (dados.usuario) {
                        const usuario = {
                            uid: doc.id,
                            login: dados.usuario,
                            nome: dados.usuario,
                            perfil: dados.nivel || 'usuario'
                        };
                        
                        const option = document.createElement('option');
                        option.value = JSON.stringify(usuario);
                        option.textContent = `${usuario.login} - ${usuario.perfil}`;
                        if (userSelect) {
                            userSelect.appendChild(option);
                        }
                    }
                });
                
                showStatus('Selecione seu usu√°rio', 'info');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
                showStatus('Erro ao carregar usu√°rios', 'error');
            }
        }

        // ========== REALIZAR LOGIN ==========
        async function performLogin(userData) {
            console.log('üîë Realizando login para:', userData.login);
            
            currentUser = userData;
            
            // Atualizar interface
            updateUserInterface();
            
            // Configurar usu√°rio no chat RTDB
            await setupChatUser(currentUser);
            await fixOnlineStatus(); 
            
            // Carregar todos os usu√°rios para conversar
            await loadAllUsers();
            await syncAllUsersToRTDB(); 
            
            // Configurar listeners em tempo real
            setupRealtimeListeners();
            
            showStatus(`‚úÖ Bem-vindo, ${currentUser.login}!`, 'success');
            
            // Esconder seletor
            const userSelectorContainer = document.getElementById('user-selector-container');
            if (userSelectorContainer) {
                userSelectorContainer.style.display = 'none';
            }
        }

        // ========== SELE√á√ÉO MANUAL DE USU√ÅRIO ==========
        async function handleUserSelection() {
            if (!userSelect || !userSelect.value) return;
            
            try {
                const userData = JSON.parse(userSelect.value);
                console.log('üë§ Usu√°rio selecionado:', userData);
                
                showStatus('Conectando ao chat...', 'info');
                await performLogin(userData);
                
            } catch (error) {
                console.error('Erro ao selecionar usu√°rio:', error);
                showStatus('Erro ao selecionar usu√°rio', 'error');
            }
        }



        // ========== CARREGAR TODOS OS USU√ÅRIOS ==========
        async function loadAllUsers() {
            try {
                console.log('üîç Carregando todos os usu√°rios...');
                const snapshot = await db.collection('LOGINS_ORGTAREFAS').get();
                allUsers = [];
                
                snapshot.forEach(doc => {
                    const docId = doc.id;
                    const dados = doc.data();
                    
                    // Percorrer todos os campos do documento
                    Object.keys(dados).forEach(campo => {
                        const valor = dados[campo];
                        
                        // Verificar se √© um objeto de usu√°rio
                        if (typeof valor === 'object' && valor !== null && valor.login) {
                            console.log(`‚úÖ Encontrado usu√°rio: ${valor.login} no campo ${campo}`);
                            
                            const usuario = {
                                uid: `${docId}_${campo}`, // Usar docId + campo como UID √∫nico
                                docId: docId,
                                campo: campo, // user1_uid, user2_uid, user3_uid
                                login: valor.login,
                                nome: valor.displayName || valor.login,
                                perfil: valor.perfil || 'Usu√°rio',
                                isOnline: valor.isOnline || false, // Pegar do Firestore
                                email: valor.email || '',
                                status: valor.status || 'Ativo'
                            };
                            
                            // Adicionar apenas se for diferente do usu√°rio atual
                            if (usuario.login !== currentUser.login) {
                                allUsers.push(usuario);
                                console.log(`üìù Adicionado usu√°rio: ${usuario.nome} (${usuario.login})`);
                            }
                        }
                    });
                });
                
                console.log(`üìä Total de usu√°rios carregados: ${allUsers.length}`);
                console.log('üë• Lista de usu√°rios:', allUsers.map(u => `${u.login} (${u.nome})`));
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
            }
        }

        
        // ========== CARREGAR TODOS OS USU√ÅRIOS DO FIRESTORE ==========
        async function getAllUsersFromFirestore() {
            try {
                const snapshot = await db.collection('LOGINS_ORGTAREFAS').get();
                const users = [];
                
                snapshot.forEach(doc => {
                    const dados = doc.data();
                    
                    Object.keys(dados).forEach(campo => {
                        const valor = dados[campo];
                        
                        if (typeof valor === 'object' && valor !== null && valor.login) {
                            const usuario = {
                                uid: `${doc.id}_${campo}`,
                                docId: doc.id,
                                campo: campo,
                                login: valor.login,
                                nome: valor.displayName || valor.login,
                                perfil: valor.perfil || 'Usu√°rio',
                                isOnline: valor.isOnline || false,
                                email: valor.email || '',
                                status: valor.status || 'Ativo'
                            };
                            
                            users.push(usuario);
                        }
                    });
                });
                
                console.log(`üìÑ Total de usu√°rios no Firestore: ${users.length}`);
                return users;
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios do Firestore:', error);
                return [];
            }
        }
        
        // ========== ATUALIZAR INTERFACE ==========
        function updateUserInterface() {
            if (!currentUser) return;
            
            // Atualizar informa√ß√µes do usu√°rio
            const userName = document.getElementById('current-user-name');
            const userLogin = document.getElementById('current-user-login');
            const userPerfil = document.getElementById('current-user-perfil');
            const userAvatar = document.getElementById('user-avatar');
            const loggedUserArea = document.getElementById('logged-user-area');
            
            if (userName) userName.textContent = currentUser.login;
            if (userLogin) userLogin.textContent = currentUser.login;
            if (userPerfil) userPerfil.textContent = currentUser.perfil;
            
            if (userAvatar) {
                const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.login)}&background=667eea&color=fff`;
                userAvatar.src = avatarUrl;
            }
            
            // Mostrar √°rea do usu√°rio logado
            if (loggedUserArea) {
                loggedUserArea.classList.remove('hidden');
            }
            
            // Mostrar se√ß√µes do chat
            const onlineUsersHeader = document.getElementById('online-users-header');
            const onlineUsersList = document.getElementById('online-users-list');
            const conversationsHeader = document.getElementById('conversations-header');
            const conversationsList = document.getElementById('conversations-list');
            
            if (onlineUsersHeader) onlineUsersHeader.classList.remove('hidden');
            if (onlineUsersList) onlineUsersList.classList.remove('hidden');
            if (conversationsHeader) conversationsHeader.classList.remove('hidden');
            if (conversationsList) conversationsList.classList.remove('hidden');
            
            // Atualizar cabe√ßalho do chat
            const chatHeader = document.querySelector('.chat-header');
            if (chatHeader) {
                chatHeader.querySelector('.default-content h2').textContent = `Ol√°, ${currentUser.login}!`;
                chatHeader.querySelector('.default-content p').textContent = 'Selecione um colega online para conversar';
            }
        }

        // ========== LISTENERS EM TEMPO REAL ==========
        function setupRealtimeListeners() {
            if (!currentUser) return;
            
            console.log('üì° Configurando listeners em tempo real...');
            
            // 1. Ouvir usu√°rios online - CORRIGIDO
            usersRef = chatDb.ref('users');
            usersRef.on('value', (snapshot) => {
                const usersData = snapshot.val();
                console.log('üìä Dados de usu√°rios recebidos:', usersData);
                onlineUsersCache = usersData || {};
                renderOnlineUsers(usersData);
            }, (error) => {
                console.error('‚ùå Erro ao ouvir usu√°rios:', error);
            });
            
            // 2. Ouvir conversas do usu√°rio
            conversationsRef = chatDb.ref(`userConversations/${currentUser.uid}`);
            conversationsRef.on('value', (snapshot) => {
                const conversationsData = snapshot.val();
                console.log('üí¨ Conversas recebidas:', conversationsData);
                renderConversations(conversationsData);
            }, (error) => {
                console.error('‚ùå Erro ao ouvir conversas:', error);
            });
        }

        // ========== RENDERIZAR USU√ÅRIOS ONLINE ==========
        function renderOnlineUsers(usersData) {
            const onlineUsersList = document.getElementById('online-users-list');
            if (!onlineUsersList) return;
            
            console.log('üë• Renderizando usu√°rios online...');
            
            if (!usersData || Object.keys(usersData).length === 0) {
                onlineUsersList.innerHTML = '<div class="loading">Carregando...</div>';
                return;
            }
            
            let html = '';
            let onlineCount = 0;
            
            // Lista de usu√°rios para mostrar (exceto o atual)
            const usersToShow = [];
            
            // Coletar usu√°rios online
            Object.keys(usersData).forEach(uid => {
                const user = usersData[uid];
                
                // Ignorar usu√°rio atual
                if (uid === currentUser.uid) return;
                
                // Verificar se est√° online
                if (user && user.isOnline === true) {
                    usersToShow.push({
                        uid: uid,
                        data: user,
                        source: 'RTDB'
                    });
                }
            });
            
            // Tamb√©m verificar usu√°rios do Firestore que podem estar online
            allUsers.forEach(fsUser => {
                // Ignorar usu√°rio atual
                if (fsUser.uid === currentUser.uid) return;
                
                // Se n√£o est√° na lista do RTDB mas est√° online no Firestore
                if (fsUser.isOnline === true && !usersData[fsUser.uid]) {
                    usersToShow.push({
                        uid: fsUser.uid,
                        data: {
                            login: fsUser.login,
                            nome: fsUser.nome,
                            perfil: fsUser.perfil,
                            isOnline: true,
                            fromFirestore: true
                        },
                        source: 'Firestore'
                    });
                }
            });
            
            // Ordenar por nome
            usersToShow.sort((a, b) => a.data.nome.localeCompare(b.data.nome));
            
            // Renderizar
            usersToShow.forEach(user => {
                onlineCount++;
                
                const displayName = user.data.nome || user.data.login;
                const perfil = user.data.perfil || 'Usu√°rio';
                const avatarUrl = user.data.avatarUrl || 
                    `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=667eea&color=fff`;
                
                html += `
                    <div class="user-online-item" data-user="${user.uid}" 
                         data-login="${user.data.login}"
                         title="${displayName} - ${perfil}">
                        <img src="${avatarUrl}" 
                             class="user-online-avatar" alt="${displayName}">
                        <div class="user-online-info">
                            <div class="user-online-name">${displayName}</div>
                            <div class="user-online-details">
                                <span class="user-online-perfil">${perfil}</span>
                                <span class="user-online-source">${user.source}</span>
                            </div>
                        </div>
                        <div class="status-indicator online" title="Online"></div>
                    </div>`;
            });
            
            console.log(`‚úÖ Usu√°rios online encontrados: ${onlineCount}`);
            
            // Atualizar contador
            const onlineCountElement = document.getElementById('online-count');
            if (onlineCountElement) {
                onlineCountElement.textContent = onlineCount;
                onlineCountElement.style.backgroundColor = onlineCount > 0 ? '#4caf50' : '#ff9800';
            }
            
            if (onlineCount === 0) {
                html = `
                    <div class="no-users">
                        <i class="fas fa-user-clock"></i>
                        <p>Nenhum colega online</p>
                        <small>Os outros usu√°rios podem n√£o estar logados no chat</small>
                        <button class="btn-refresh" onclick="forceShowAllUsers()">
                            <i class="fas fa-eye"></i> Mostrar todos os usu√°rios
                        </button>
                    </div>`;
            }
            
            onlineUsersList.innerHTML = html;
            
            // Adicionar listeners
            document.querySelectorAll('.user-online-item').forEach(item => {
                item.addEventListener('click', () => {
                    const userId = item.dataset.user;
                    startNewConversation(userId);
                });
            });
        }
        
        // ========== FOR√áAR MOSTRAR TODOS OS USU√ÅRIOS ==========
        async function forceShowAllUsers() {
            console.log('üëÅÔ∏è Mostrando todos os usu√°rios...');
            
            const onlineUsersList = document.getElementById('online-users-list');
            if (!onlineUsersList) return;
            
            let html = '';
            
            // Mostrar todos os usu√°rios (mesmo offline)
            allUsers.forEach(user => {
                const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.nome)}&background=667eea&color=fff`;
                const isOnline = user.isOnline === true;
                
                html += `
                    <div class="user-online-item ${isOnline ? '' : 'offline'}" 
                         data-user="${user.uid}"
                         data-login="${user.login}"
                         title="${user.nome} - ${isOnline ? 'Online' : 'Offline'}">
                        <img src="${avatarUrl}" 
                             class="user-online-avatar" alt="${user.nome}">
                        <div class="user-online-info">
                            <div class="user-online-name">${user.nome}</div>
                            <div class="user-online-details">
                                <span class="user-online-perfil">${user.perfil}</span>
                                <span class="user-online-status ${isOnline ? 'online' : 'offline'}">
                                    ‚óè ${isOnline ? 'Online' : 'Offline'}
                                </span>
                            </div>
                        </div>
                    </div>`;
            });
            
            onlineUsersList.innerHTML = html;
        }
        
        // ========== SINCRONIZAR TODOS OS USU√ÅRIOS COM RTDB ==========
        async function syncAllUsersToRTDB() {
            try {
                console.log('üîÑ Sincronizando todos os usu√°rios com RTDB...');
                
                // Primeiro, carregar TODOS os usu√°rios do Firestore (incluindo o atual)
                const allFirestoreUsers = await getAllUsersFromFirestore();
                
                for (const user of allFirestoreUsers) {
                    const userRef = chatDb.ref(`users/${user.uid}`);
                    const snapshot = await userRef.once('value');
                    
                    if (!snapshot.exists()) {
                        // Usu√°rio n√£o existe, adicionar com status CORRETO do Firestore
                        const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.nome)}&background=667eea&color=fff`;
                        
                        await userRef.set({
                            uid: user.uid,
                            login: user.login,
                            nome: user.nome,
                            perfil: user.perfil,
                            avatarUrl: avatarUrl,
                            isOnline: user.isOnline || false,
                            lastSeen: Date.now(),
                            fromFirestore: true,
                            firestoreOnline: user.isOnline
                        });
                        
                        console.log(`‚úÖ ${user.login} adicionado ao RTDB (online: ${user.isOnline})`);
                    } else {
                        // Atualizar com status do Firestore
                        const existingData = snapshot.val();
                        
                        // SEMPRE atualizar com o status do Firestore
                        await userRef.update({
                            isOnline: user.isOnline,
                            lastSeen: user.isOnline ? Date.now() : existingData.lastSeen,
                            firestoreOnline: user.isOnline
                        });
                        
                        console.log(`üìù ${user.login} atualizado: online=${user.isOnline} (Firestore: ${user.isOnline})`);
                    }
                }
                
                console.log('‚úÖ Sincroniza√ß√£o completa');
                
            } catch (error) {
                console.error('‚ùå Erro ao sincronizar usu√°rios:', error);
            }
        }
        
        // ========== ATUALIZAR USU√ÅRIOS ONLINE ==========
        function refreshOnlineUsers() {
            console.log('üîÑ Atualizando lista de usu√°rios online...');
            if (usersRef) {
                usersRef.once('value').then((snapshot) => {
                    renderOnlineUsers(snapshot.val());
                });
            }
        }

        // ========== CONFIGURAR USU√ÅRIO NO CHAT ==========
        async function setupChatUser(userData) {
            console.log('‚öôÔ∏è Configurando usu√°rio no RTDB:', userData);
            
            // For√ßar o usu√°rio atual como ONLINE
            userData.isOnline = true;
            
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.nome)}&background=667eea&color=fff`;
            
            const userRef = chatDb.ref(`users/${userData.uid}`);
            
            try {
                await userRef.set({
                    uid: userData.uid,
                    login: userData.login,
                    nome: userData.nome,
                    perfil: userData.perfil,
                    avatarUrl: avatarUrl,
                    isOnline: true, // SEMPRE true para usu√°rio atual
                    lastSeen: Date.now(),
                    isCurrentUser: true
                });
                
                console.log('‚úÖ Usu√°rio atual configurado como ONLINE no RTDB');
                
                // Configurar desconex√£o autom√°tica
                userRef.child('isOnline').onDisconnect().set(false);
                userRef.child('lastSeen').onDisconnect().set(Date.now());
                
            } catch (error) {
                console.error('‚ùå Erro ao configurar usu√°rio no RTDB:', error);
            }
        }


        // ========== RENDERIZAR CONVERSAS ==========
        function renderConversations(conversationsData) {
            const conversationsList = document.getElementById('conversations-list');
            if (!conversationsList) return;
            
            if (!conversationsData || Object.keys(conversationsData).length === 0) {
                conversationsList.innerHTML = `
                    <div class="no-conversations">
                        <i class="fas fa-comments"></i>
                        <p>Nenhuma conversa ainda</p>
                        <small>Selecione um usu√°rio online para come√ßar</small>
                    </div>`;
                return;
            }
            
            let html = '';
            const conversations = Object.entries(conversationsData);
            
            // Atualizar contador
            const conversationsCount = document.getElementById('conversations-count');
            if (conversationsCount) {
                conversationsCount.textContent = conversations.length;
            }
            
            conversations.forEach(([conversationId, conversationData]) => {
                const otherUserId = getOtherUserId(conversationData.participants);
                const otherUser = allUsers.find(u => u.uid === otherUserId);
                
                if (otherUser) {
                    const isActive = currentConversation === conversationId;
                    const time = conversationData.lastTimestamp ? 
                        formatTime(conversationData.lastTimestamp) : '';
                    
                    html += `
                        <div class="conversation-item ${isActive ? 'active' : ''}" 
                             data-conversation="${conversationId}"
                             data-user="${otherUserId}">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(otherUser.login)}&background=667eea&color=fff" 
                                 class="conversation-avatar" alt="${otherUser.login}">
                            <div class="conversation-details">
                                <div class="conversation-name">${otherUser.login}</div>
                                <div class="conversation-last-message">${conversationData.lastMessage || ''}</div>
                            </div>
                            <div class="conversation-time">${time}</div>
                        </div>`;
                }
            });
            
            conversationsList.innerHTML = html;
            
            // Adicionar listeners para abrir conversas
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', () => {
                    const conversationId = item.dataset.conversation;
                    const userId = item.dataset.user;
                    openConversation(conversationId, userId);
                });
            });
        }

        // ========== INICIAR NOVA CONVERSA ==========
        async function startNewConversation(otherUserId) {
            console.log('üí¨ Iniciando nova conversa com:', otherUserId);
            
            const otherUser = allUsers.find(u => u.uid === otherUserId);
            if (!otherUser) {
                showStatus('Usu√°rio n√£o encontrado', 'error');
                return;
            }
            
            const conversationId = [currentUser.uid, otherUserId].sort().join('_');
            console.log('ID da conversa:', conversationId);
            
            try {
                const conversationRef = chatDb.ref(`userConversations/${currentUser.uid}/${conversationId}`);
                const snapshot = await conversationRef.once('value');
                
                if (!snapshot.exists()) {
                    const conversationData = {
                        participants: {
                            [currentUser.uid]: true,
                            [otherUserId]: true
                        },
                        lastMessage: '',
                        lastTimestamp: Date.now(),
                        unreadCount: 0
                    };
                    
                    await conversationRef.set(conversationData);
                    await chatDb.ref(`userConversations/${otherUserId}/${conversationId}`).set(conversationData);
                    
                    console.log('‚úÖ Nova conversa criada');
                }
                
                openConversation(conversationId, otherUserId);
                
            } catch (error) {
                console.error('‚ùå Erro ao criar conversa:', error);
                showStatus('Erro ao iniciar conversa', 'error');
            }
        }

        // ========== ABRIR CONVERSA ==========
        function openConversation(conversationId, otherUserId) {
            console.log('üìÇ Abrindo conversa:', conversationId);
            
            currentConversation = conversationId;
            const otherUser = allUsers.find(u => u.uid === otherUserId);
            
            if (!otherUser) return;
            
            // Atualizar cabe√ßalho
            const chatInfoDefault = document.getElementById('chat-info-default');
            const chatInfoActive = document.getElementById('chat-info-active');
            const activeUserName = document.getElementById('active-user-name');
            const activeUserAvatar = document.getElementById('active-user-avatar');
            const activeUserPerfil = document.getElementById('active-user-perfil');
            
            if (chatInfoDefault) chatInfoDefault.classList.add('hidden');
            if (chatInfoActive) chatInfoActive.classList.remove('hidden');
            if (activeUserName) activeUserName.textContent = otherUser.login;
            if (activeUserPerfil) activeUserPerfil.textContent = otherUser.perfil;
            
            if (activeUserAvatar) {
                const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(otherUser.login)}&background=667eea&color=fff`;
                activeUserAvatar.src = avatarUrl;
            }
            
            // Mostrar input de mensagem
            const messageInputArea = document.getElementById('message-input-area');
            if (messageInputArea) {
                messageInputArea.classList.remove('hidden');
            }
            
            // Carregar mensagens
            loadMessages(conversationId);
        }

        // ========== CARREGAR MENSAGENS ==========
        function loadMessages(conversationId) {
            if (messagesRef) {
                messagesRef.off();
            }
            
            messagesRef = chatDb.ref(`messages/${conversationId}`);
            messagesRef.orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
                const messagesData = snapshot.val();
                const messagesContainer = document.getElementById('messages-container');
                
                if (!messagesContainer) return;
                
                if (messagesData) {
                    const messages = [];
                    Object.keys(messagesData).forEach(key => {
                        messages.push({ id: key, ...messagesData[key] });
                    });
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    renderMessages(messages);
                } else {
                    messagesContainer.innerHTML = `
                        <div class="no-messages">
                            <i class="fas fa-comment-slash"></i>
                            <p>Nenhuma mensagem ainda</p>
                            <small>Envie a primeira mensagem!</small>
                        </div>`;
                }
            });
        }

        // ========== ENVIAR MENSAGEM ==========
        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            if (!currentUser || !currentConversation || !messageInput || !messageInput.value.trim()) {
                return;
            }
            
            const text = messageInput.value.trim();
            const messageId = chatDb.ref().push().key;
            const timestamp = Date.now();
            
            console.log('üì§ Enviando mensagem:', text);
            
            try {
                await chatDb.ref(`messages/${currentConversation}/${messageId}`).set({
                    id: messageId,
                    senderId: currentUser.uid,
                    senderName: currentUser.nome,
                    senderLogin: currentUser.login,
                    text: text,
                    timestamp: timestamp,
                    read: false
                });
                
                const otherUserId = getOtherUserIdFromConversation(currentConversation);
                if (otherUserId) {
                    const conversationUpdate = {
                        lastMessage: text,
                        lastTimestamp: timestamp
                    };
                    
                    await chatDb.ref(`userConversations/${currentUser.uid}/${currentConversation}`).update(conversationUpdate);
                    await chatDb.ref(`userConversations/${otherUserId}/${currentConversation}`).update(conversationUpdate);
                }
                
                messageInput.value = '';
                scrollToBottom();
                
            } catch (error) {
                console.error('‚ùå Erro ao enviar mensagem:', error);
                showStatus('Erro ao enviar mensagem', 'error');
            }
        }

        // ========== FUN√á√ïES AUXILIARES ==========
        function getOtherUserId(participants) {
            if (!participants) return null;
            const participantIds = Object.keys(participants);
            return participantIds.find(id => id !== currentUser.uid);
        }

        function getOtherUserIdFromConversation(conversationId) {
            const parts = conversationId.split('_');
            return parts.find(part => part !== currentUser.uid);
        }

        function renderMessages(messages) {
            const messagesContainer = document.getElementById('messages-container');
            if (!messagesContainer) return;
            
            messagesContainer.innerHTML = '';
            
            messages.forEach(msg => {
                const div = document.createElement('div');
                const isSent = msg.senderId === currentUser.uid;
                const time = formatTime(msg.timestamp);
                
                div.className = `message ${isSent ? 'sent' : 'received'}`;
                div.innerHTML = `
                    <div class="message-header">
                        <span class="message-sender">${msg.senderName}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${msg.text}</div>
                `;
                
                messagesContainer.appendChild(div);
            });
            
            scrollToBottom();
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('messages-container');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function showStatus(message, type) {
            if (!loginStatus) return;
            
            loginStatus.textContent = message;
            loginStatus.className = 'login-status';
            
            switch(type) {
                case 'error':
                    loginStatus.style.color = '#f44336';
                    loginStatus.style.backgroundColor = '#ffebee';
                    break;
                case 'success':
                    loginStatus.style.color = '#4caf50';
                    loginStatus.style.backgroundColor = '#e8f5e8';
                    break;
                default:
                    loginStatus.style.color = '#2196f3';
                    loginStatus.style.backgroundColor = '#e3f2fd';
            }
            
            loginStatus.style.display = 'block';
            
            if (type !== 'error') {
                setTimeout(() => {
                    loginStatus.style.display = 'none';
                }, 3000);
            }
        }

        // ========== INICIAR APP ==========
        document.addEventListener('DOMContentLoaded', init);
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            color: #333;
        }
        
        .container {
            width: 100%;
            height: 100%;
        }
        
        .screen {
            width: 100%;
            height: 100%;
            display: flex;
        }
        
        /* SIDEBAR */
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .sidebar-header h3 {
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .app-name {
            font-size: 12px;
            color: #667eea;
            background: #f0f2f5;
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .btn-logout {
            background: #f0f2f5;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            background: #ffebee;
            color: #f44336;
            transform: rotate(-90deg);
        }
        
        /* USU√ÅRIO ATUAL */
        .user-info {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #eee;
            background: white;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .user-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .user-name {
            font-weight: 700;
            color: #333;
            font-size: 18px;
        }
        
        .user-info-bottom {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .user-login {
            font-size: 13px;
            color: #666;
            background: #f0f2f5;
            padding: 3px 10px;
            border-radius: 10px;
        }
        
        .user-perfil {
            font-size: 12px;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .status-online {
            font-size: 12px;
            color: #4caf50;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-online:before {
            content: '‚óè';
            font-size: 16px;
        }
        
        /* SELETOR DE USU√ÅRIO */
        .user-selector-container {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .section-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f0f2f5;
        }
        
        .section-header h4 {
            font-size: 14px;
            color: #666;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .count-badge {
            background: #667eea;
            color: white;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            min-width: 25px;
            text-align: center;
            font-weight: 600;
        }
        
        .user-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .user-select-dropdown {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            background: #f8f9fa;
            color: #333;
        }
        
        .user-select-dropdown:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }
        
        .btn-confirm-user {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-confirm-user:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-confirm-user:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .login-status {
            margin-top: 10px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            display: none;
        }
        
        /* USU√ÅRIOS ONLINE */
        .online-users {
            padding: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            flex: 1;
        }
        
        .user-online-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .user-online-item:hover {
            background: #f8f9fa;
        }
        
        .user-online-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #4caf50;
        }
        
        .user-online-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .user-online-perfil {
            font-size: 12px;
            color: #666;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
            box-shadow: 0 0 5px #4caf50;
            margin-left: auto;
        }
        
        /* CONVERSAS */
        .conversations-list {
            flex: 2;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .conversation-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .conversation-item:hover {
            background: #f8f9fa;
        }
        
        .conversation-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-left: 3px solid #667eea;
        }
        
        .conversation-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e1e5e9;
        }
        
        .conversation-details {
            flex: 1;
            min-width: 0;
        }
        
        .conversation-name {
            font-weight: 600;
            color: #333;
            font-size: 15px;
            margin-bottom: 4px;
        }
        
        .conversation-last-message {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .conversation-time {
            font-size: 11px;
            color: #999;
            white-space: nowrap;
        }
        
        /* LOADING STATES */
        .loading-conversations, .loading-online {
            padding: 40px 20px;
            text-align: center;
            color: #666;
        }
        
        .loading-conversations i, .loading-online i {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .loading-conversations p, .loading-online p {
            font-size: 14px;
            color: #888;
        }
        
        .no-conversations, .no-users {
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }
        
        .no-conversations i, .no-users i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* √ÅREA PRINCIPAL */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-info-default, .chat-info-active {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .default-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        .default-content h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .default-content p {
            color: #666;
            font-size: 14px;
        }
        
        .active-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .active-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
        }
        
        .active-user-info h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .active-user-details {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-perfil-small {
            font-size: 12px;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2px 8px;
            border-radius: 8px;
        }
        
        .user-status {
            font-size: 12px;
            color: #4caf50;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* √ÅREA DE MENSAGENS */
        .messages-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #666;
        }
        
        .welcome-icon {
            font-size: 80px;
            color: #667eea;
            margin-bottom: 30px;
            opacity: 0.7;
        }
        
        .welcome-content h3 {
            font-size: 28px;
            color: #333;
            margin-bottom: 15px;
        }
        
        .welcome-content p {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
        }
        
        .welcome-features {
            display: flex;
            justify-content: center;
            gap: 30px;
        }
        
        .feature {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .feature i {
            font-size: 24px;
            color: #667eea;
        }
        
        .feature span {
            font-size: 14px;
            color: #666;
        }
        
        /* MENSAGENS */
        .message {
            max-width: 70%;
            padding: 15px;
            border-radius: 18px;
            margin-bottom: 15px;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message.received {
            align-self: flex-start;
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .message-sender {
            font-weight: 600;
            font-size: 13px;
        }
        
        .message-time {
            opacity: 0.8;
            font-size: 12px;
        }
        
        .message.received .message-time {
            color: #888;
        }
        
        .message-text {
            line-height: 1.5;
            font-size: 15px;
        }
        
        /* INPUT DE MENSAGEM */
        .message-input-area {
            background: white;
            padding: 20px 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            border-top: 1px solid #ddd;
        }
        
        #message-input {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            font-size: 16px;
            background: #f8f9fa;
        }
        
        #message-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }
        
        .btn-send {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .hidden {
            display: none !important;
        }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* RESPONSIVIDADE */
        @media (max-width: 768px) {
            .screen {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
            }
            
            .main-content {
                height: 60vh;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</body>
</html>
