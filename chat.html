<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat OrgTarefas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <!-- Tela do Chat -->
        <div id="chat-screen" class="screen">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="header-left">
                        <h3><i class="fas fa-comments"></i> Mensagens</h3>
                        <span class="app-name">OrgTarefas</span>
                    </div>
                    <button id="back-btn" class="btn-logout" title="Voltar ao sistema" onclick="window.location.href='index.html'">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                
                <!-- Seletor de Usu√°rio -->
                <div class="user-selector-container">
                    <div class="section-header">
                        <h4><i class="fas fa-user"></i> Eu sou</h4>
                    </div>
                    <div class="user-selector">
                        <select id="user-select" class="user-select-dropdown">
                            <option value="">Selecione seu usu√°rio...</option>
                            <!-- Os usu√°rios ser√£o carregados dinamicamente -->
                        </select>
                        <button id="confirm-user-btn" class="btn-confirm-user" disabled>
                            <i class="fas fa-check"></i> Entrar no Chat
                        </button>
                    </div>
                    <div id="login-status" class="login-status"></div>
                </div>
                
                <!-- √Årea do Usu√°rio Logado -->
                <div class="user-info hidden" id="logged-user-area">
                    <img id="user-avatar" src="" alt="Avatar" class="user-avatar">
                    <div class="user-details">
                        <span id="current-user-name" class="user-name">Carregando...</span>
                        <div class="user-info-bottom">
                            <span id="current-user-login" class="user-login"></span>
                            <span id="current-user-perfil" class="user-perfil"></span>
                            <span id="online-status" class="status-online">‚óè online</span>
                        </div>
                    </div>
                </div>
                
                <!-- Pesquisa -->
                <div class="search-container hidden" id="search-section">
                    <div class="input-group search-group">
                        <input type="text" id="search-input" placeholder="Pesquisar conversas...">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                
                <!-- Lista de conversas -->
                <div class="section-header hidden" id="conversations-header">
                    <h4><i class="fas fa-inbox"></i> Conversas</h4>
                    <span id="conversations-count" class="count-badge">0</span>
                </div>
                <div class="conversations-list hidden" id="conversations-list">
                    <div class="loading-conversations">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Carregando suas conversas...</p>
                    </div>
                </div>
                
                <!-- Usu√°rios online -->
                <div class="section-header hidden" id="online-users-header">
                    <h4><i class="fas fa-user-check"></i> Colegas Online</h4>
                    <span id="online-count" class="count-badge">0</span>
                </div>
                <div class="online-users hidden" id="online-users-list">
                    <div class="loading-online">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Buscando colegas online...</p>
                    </div>
                </div>
            </div>

            <!-- √Årea principal do chat -->
            <div class="main-content">
                <!-- Cabe√ßalho da conversa -->
                <div class="chat-header" id="chat-header">
                    <div class="chat-info-default" id="chat-info-default">
                        <div class="default-icon">
                            <i class="fas fa-comment-dots"></i>
                        </div>
                        <div class="default-content">
                            <h2>Bem-vindo ao Chat</h2>
                            <p>Selecione um usu√°rio para come√ßar a conversar</p>
                        </div>
                    </div>
                    
                    <div class="chat-info-active hidden" id="chat-info-active">
                        <div class="active-user">
                            <img id="active-user-avatar" src="" alt="Avatar" class="active-avatar">
                            <div class="active-user-info">
                                <h2 id="active-user-name">Nome do Usu√°rio</h2>
                                <div class="active-user-details">
                                    <span id="active-user-perfil" class="user-perfil-small"></span>
                                    <span id="active-user-status" class="user-status">‚óè online</span>
                                </div>
                            </div>
                        </div>
                        <div class="chat-actions">
                            <button class="btn-action" title="Informa√ß√µes">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- √Årea de mensagens -->
                <div class="messages-area">
                    <div class="messages-container" id="messages-container">
                        <div class="welcome-screen" id="welcome-screen">
                            <div class="welcome-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="welcome-content">
                                <h3>Chat em Tempo Real</h3>
                                <p>Conecte-se com seus colegas de trabalho</p>
                                <div class="welcome-features">
                                    <div class="feature">
                                        <i class="fas fa-shield-alt"></i>
                                        <span>Seguro e privado</span>
                                    </div>
                                    <div class="feature">
                                        <i class="fas fa-history"></i>
                                        <span>Hist√≥rico salvo</span>
                                    </div>
                                    <div class="feature">
                                        <i class="fas fa-bolt"></i>
                                        <span>Tempo real</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Input de mensagem -->
                    <div class="message-input-area hidden" id="message-input-area">
                        <div class="input-tools">
                            <button id="emoji-btn" class="btn-tool" title="Emoji">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button id="attach-btn" class="btn-tool" title="Anexar arquivo">
                                <i class="fas fa-paperclip"></i>
                            </button>
                        </div>
                        <input type="text" id="message-input" placeholder="Digite sua mensagem..." autocomplete="off">
                        <button id="send-btn" class="btn-send">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURA√á√ÉO FIREBASE ==========
        // Usando a mesma configura√ß√£o do sistema principal
        const firebaseConfig = {
            apiKey: "AIzaSyAs0Ke4IBfBWDrfH0AXaOhCEjtfpPtR_Vg",
            authDomain: "orgtarefas-85358.firebaseapp.com",
            projectId: "orgtarefas-85358",
            storageBucket: "orgtarefas-85358.firebasestorage.app",
            messagingSenderId: "1023569488575",
            appId: "1:1023569488575:web:18f9e201115a1a92ccb40a"
        };

        // Configura√ß√£o adicional para o Realtime Database (chat)
        const chatFirebaseConfig = {
            apiKey: "AIzaSyAYROPCh-558mNXPrO7onAXFvfBe13q5Js",
            authDomain: "orgtarefas-chat.firebaseapp.com",
            databaseURL: "https://orgtarefas-chat-default-rtdb.firebaseio.com",
            projectId: "orgtarefas-chat",
            storageBucket: "orgtarefas-chat.firebasestorage.app",
            messagingSenderId: "380919096800",
            appId: "1:380919096800:web:7b54e7e341c9266c207785"
        };

        // ========== INICIALIZAR APPS ==========
        const mainApp = firebase.initializeApp(firebaseConfig, 'mainApp');
        const chatApp = firebase.initializeApp(chatFirebaseConfig);

        // ========== REFER√äNCIAS ==========
        const db = firebase.firestore(mainApp);
        const chatDb = firebase.database();

        // ========== ELEMENTOS DOM ==========
        const userSelect = document.getElementById('user-select');
        const confirmUserBtn = document.getElementById('confirm-user-btn');
        const loginStatus = document.getElementById('login-status');
        const loggedUserArea = document.getElementById('logged-user-area');
        const userSelectorContainer = document.querySelector('.user-selector-container');
        const searchSection = document.getElementById('search-section');
        const conversationsHeader = document.getElementById('conversations-header');
        const conversationsList = document.getElementById('conversations-list');
        const onlineUsersHeader = document.getElementById('online-users-header');
        const onlineUsersList = document.getElementById('online-users-list');
        
        // Elementos do usu√°rio
        const currentUserName = document.getElementById('current-user-name');
        const currentUserLogin = document.getElementById('current-user-login');
        const userAvatar = document.getElementById('user-avatar');
        const onlineStatus = document.getElementById('online-status');
        
        // Elementos do chat
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const messageInputArea = document.getElementById('message-input-area');
        const chatInfoDefault = document.getElementById('chat-info-default');
        const chatInfoActive = document.getElementById('chat-info-active');
        const activeUserName = document.getElementById('active-user-name');
        const activeUserAvatar = document.getElementById('active-user-avatar');
        const activeUserPerfil = document.getElementById('active-user-perfil');
        const activeUserStatus = document.getElementById('active-user-status');
        
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let currentUser = null;
        let currentConversation = null;
        let conversationsRef = null;
        let usersRef = null;
        let messagesRef = null;
        let allRealUsers = [];
        let onlineUsersCache = {};

        // ========== INICIALIZA√á√ÉO ==========
        async function init() {
            console.log('üöÄ Inicializando chat...');
            setupEventListeners();
            await loadUsersFromFirestore();
        }

        // ========== CARREGAR USU√ÅRIOS DO FIRESTORE ==========
        async function loadUsersFromFirestore() {
            try {
                console.log('üîç Carregando usu√°rios da cole√ß√£o LOGINS_ORGTAREFAS...');
                
                // Carregar todos os documentos da cole√ß√£o
                const querySnapshot = await db.collection('LOGINS_ORGTAREFAS').get();
                
                let users = [];
                
                querySnapshot.forEach(doc => {
                    const docId = doc.id;
                    const dados = doc.data();
                    
                    console.log(`üìÑ Analisando documento: ${docId}`, dados);
                    
                    // Verificar cada campo do documento
                    Object.keys(dados).forEach(fieldName => {
                        const fieldValue = dados[fieldName];
                        
                        // Se o campo for um objeto com propriedades de usu√°rio
                        if (typeof fieldValue === 'object' && fieldValue !== null) {
                            console.log(`  üîç Analisando campo: ${fieldName}`, fieldValue);
                            
                            // Verificar se tem as propriedades b√°sicas de usu√°rio
                            if (fieldValue.login && fieldValue.displayName) {
                                const usuario = {
                                    uid: `${docId}_${fieldName}`, // ID √∫nico: docId_fieldName
                                    docId: docId,
                                    campo: fieldName,
                                    login: fieldValue.login,
                                    nome: fieldValue.displayName,
                                    perfil: fieldValue.perfil || 'Usu√°rio',
                                    email: fieldValue.email || '',
                                    status: fieldValue.status || 'Ativo',
                                    senha: fieldValue.senha || '',
                                    isOnline: fieldValue.isOnline || false
                                };
                                users.push(usuario);
                                console.log(`‚úÖ Usu√°rio encontrado: ${usuario.nome} (${usuario.login})`);
                            }
                        }
                    });
                });
                
                console.log(`üìä Total de usu√°rios encontrados: ${users.length}`);
                
                if (users.length === 0) {
                    showStatus('Nenhum usu√°rio encontrado na cole√ß√£o LOGINS_ORGTAREFAS', 'error');
                } else {
                    // Popular o select
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify(user);
                        option.textContent = `${user.nome} (${user.login}) - ${user.perfil}`;
                        userSelect.appendChild(option);
                    });
                    
                    showStatus(`${users.length} usu√°rios carregados com sucesso`, 'success');
                    setTimeout(() => {
                        loginStatus.style.display = 'none';
                    }, 2000);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
                showStatus('Erro ao carregar usu√°rios: ' + error.message, 'error');
            }
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            // Seletor de usu√°rio
            userSelect.addEventListener('change', (e) => {
                confirmUserBtn.disabled = !e.target.value;
            });
            
            confirmUserBtn.addEventListener('click', handleUserSelection);
            
            // Mensagens
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // ========== SELE√á√ÉO DE USU√ÅRIO ==========
        async function handleUserSelection() {
            if (!userSelect.value) return;
            
            try {
                const userData = JSON.parse(userSelect.value);
                showStatus('Conectando ao chat...', 'info');
                
                currentUser = userData;
                
                // 1. Carregar TODOS os usu√°rios reais
                await loadAllRealUsers();
                
                // 2. Configurar usu√°rio no chat
                await setupChatUser(currentUser);
                
                // 3. Atualizar interface
                updateUserInterface();
                
                // 4. Configurar listeners em tempo real
                setupRealtimeListeners();
                
                showStatus(`‚úÖ Bem-vindo, ${currentUser.nome}!`, 'success');
                
            } catch (error) {
                console.error('‚ùå Erro ao selecionar usu√°rio:', error);
                showStatus('Erro: ' + error.message, 'error');
            }
        }

        // ========== CARREGAR TODOS OS USU√ÅRIOS REAIS ==========
        async function loadAllRealUsers() {
            try {
                console.log('üîç Carregando TODOS os usu√°rios...');
                const snapshot = await db.collection('LOGINS_ORGTAREFAS').get();
                allRealUsers = [];
                
                snapshot.forEach(doc => {
                    const dados = doc.data();
                    
                    // Percorrer todos os campos do documento
                    for (const [campo, valor] of Object.entries(dados)) {
                        if (typeof valor === 'object' && valor !== null && valor.login) {
                            const usuario = {
                                uid: `${doc.id}_${campo}`,
                                docId: doc.id,
                                campo: campo,
                                login: valor.login,
                                nome: valor.displayName || valor.login,
                                perfil: valor.perfil || 'Usu√°rio',
                                email: valor.email || '',
                                status: valor.status || 'Ativo'
                            };
                            
                            // Adicionar apenas se for diferente do usu√°rio atual
                            if (usuario.uid !== currentUser.uid) {
                                allRealUsers.push(usuario);
                                console.log(`üë§ Usu√°rio carregado: ${usuario.nome} (${usuario.login})`);
                            }
                        }
                    }
                });
                
                console.log(`üìä Total de usu√°rios reais carregados: ${allRealUsers.length}`);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
            }
        }

        // ========== CONFIGURAR USU√ÅRIO NO CHAT ==========
        async function setupChatUser(userData) {
            console.log('‚öôÔ∏è Configurando usu√°rio no chat:', userData);
            
            // Gerar avatar
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.nome)}&background=667eea&color=fff`;
            
            // Salvar no RTDB do chat
            const userRef = chatDb.ref(`users/${userData.uid}`);
            
            try {
                await userRef.set({
                    uid: userData.uid,
                    login: userData.login,
                    nome: userData.nome,
                    perfil: userData.perfil,
                    avatarUrl: avatarUrl,
                    isOnline: true,
                    lastSeen: Date.now()
                });
                
                console.log('‚úÖ Usu√°rio salvo no RTDB');
                
                // Configurar desconex√£o autom√°tica
                userRef.child('isOnline').onDisconnect().set(false);
                userRef.child('lastSeen').onDisconnect().set(Date.now());
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar usu√°rio no RTDB:', error);
            }
            
            return userData;
        }

        // ========== ATUALIZAR INTERFACE DO USU√ÅRIO ==========
        function updateUserInterface() {
            // Mostrar √°rea do usu√°rio logado
            currentUserName.textContent = currentUser.nome;
            currentUserLogin.textContent = currentUser.login;
            
            // Gerar avatar
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.nome)}&background=667eea&color=fff`;
            userAvatar.src = avatarUrl;
            
            // Mostrar/ocultar elementos
            userSelectorContainer.classList.add('hidden');
            loggedUserArea.classList.remove('hidden');
            searchSection.classList.remove('hidden');
            conversationsHeader.classList.remove('hidden');
            conversationsList.classList.remove('hidden');
            onlineUsersHeader.classList.remove('hidden');
            onlineUsersList.classList.remove('hidden');
        }

        // ========== LISTENERS EM TEMPO REAL ==========
        function setupRealtimeListeners() {
            if (!currentUser) return;
            
            console.log('üì° Configurando listeners em tempo real...');
            
            // 1. Ouvir conversas do usu√°rio atual
            conversationsRef = chatDb.ref(`userConversations/${currentUser.uid}`);
            conversationsRef.on('value', (snapshot) => {
                const conversationsData = snapshot.val();
                renderConversations(conversationsData);
            });
            
            // 2. Ouvir usu√°rios online no chat
            usersRef = chatDb.ref('users');
            usersRef.on('value', (snapshot) => {
                const usersData = snapshot.val();
                onlineUsersCache = usersData || {};
                renderOnlineUsers(usersData);
            });
        }

        // ========== RENDERIZAR CONVERSAS ==========
        function renderConversations(conversationsData) {
            console.log('üí¨ Renderizando conversas...', conversationsData);
            
            if (!conversationsData || Object.keys(conversationsData).length === 0) {
                conversationsList.innerHTML = `
                    <div class="no-conversations">
                        <i class="fas fa-comments"></i>
                        <p>Nenhuma conversa ainda</p>
                        <small>Selecione um usu√°rio online para come√ßar</small>
                    </div>`;
                return;
            }
            
            let html = '';
            const conversations = Object.entries(conversationsData);
            
            conversations.forEach(([conversationId, conversationData]) => {
                // Encontrar o outro usu√°rio da conversa
                const otherUserId = getOtherUserId(conversationData.participants);
                
                // Buscar informa√ß√µes REAIS do usu√°rio
                const otherUser = allRealUsers.find(u => u.uid === otherUserId);
                
                if (otherUser) {
                    const isActive = currentConversation === conversationId;
                    const time = conversationData.lastTimestamp ? 
                        formatTime(conversationData.lastTimestamp) : '';
                    
                    html += `
                        <div class="conversation-item ${isActive ? 'active' : ''}" 
                             data-conversation="${conversationId}"
                             data-user="${otherUserId}">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(otherUser.nome)}&background=667eea&color=fff" 
                                 class="conversation-avatar" alt="${otherUser.nome}">
                            <div class="conversation-details">
                                <div class="conversation-name">${otherUser.nome}</div>
                                <div class="conversation-last-message">${conversationData.lastMessage || ''}</div>
                            </div>
                            <div class="conversation-time">${time}</div>
                            ${conversationData.unreadCount > 0 ? 
                                `<div class="unread-badge">${conversationData.unreadCount}</div>` : ''}
                        </div>`;
                }
            });
            
            conversationsList.innerHTML = html;
            
            // Adicionar listeners para conversas
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', () => {
                    const conversationId = item.dataset.conversation;
                    const userId = item.dataset.user;
                    openConversation(conversationId, userId);
                });
            });
        }

        // ========== RENDERIZAR USU√ÅRIOS ONLINE ==========
        function renderOnlineUsers(usersData) {
            console.log('üë• Renderizando usu√°rios online...', usersData);
            
            if (!usersData) {
                onlineUsersList.innerHTML = '<div class="loading">Carregando...</div>';
                return;
            }
            
            let html = '';
            const onlineUsers = [];
            
            // Filtrar usu√°rios que est√£o online E s√£o diferentes do usu√°rio atual
            Object.keys(usersData).forEach(uid => {
                const user = usersData[uid];
                if (user.isOnline && uid !== currentUser.uid) {
                    onlineUsers.push({
                        uid: uid,
                        login: user.login,
                        nome: user.nome || 'Usu√°rio',
                        perfil: user.perfil || 'Online',
                        avatarUrl: user.avatarUrl
                    });
                }
            });
            
            if (onlineUsers.length === 0) {
                html = '<div class="no-users">Nenhum usu√°rio online</div>';
            } else {
                onlineUsers.forEach(user => {
                    // Tentar encontrar informa√ß√µes mais completas nos usu√°rios reais
                    const realUser = allRealUsers.find(u => u.uid === user.uid);
                    const displayName = realUser ? realUser.nome : user.nome;
                    const perfil = realUser ? realUser.perfil : user.perfil;
                    
                    html += `
                        <div class="user-online-item" data-user="${user.uid}">
                            <img src="${user.avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=667eea&color=fff`}" 
                                 class="user-online-avatar" alt="${displayName}">
                            <div>
                                <div class="user-online-name">${displayName}</div>
                                <div class="user-online-perfil">${perfil}</div>
                            </div>
                            <div class="status-indicator online"></div>
                        </div>`;
                });
            }
            
            onlineUsersList.innerHTML = html;
            
            // Adicionar listeners para usu√°rios online
            document.querySelectorAll('.user-online-item').forEach(item => {
                item.addEventListener('click', () => {
                    const userId = item.dataset.user;
                    startNewConversation(userId);
                });
            });
        }

        // ========== INICIAR NOVA CONVERSA ==========
        async function startNewConversation(otherUserId) {
            console.log('üí¨ Iniciando nova conversa com:', otherUserId);
            
            // Encontrar informa√ß√µes REAIS do outro usu√°rio
            const otherUser = allRealUsers.find(u => u.uid === otherUserId);
            
            if (!otherUser) {
                console.error('‚ùå Usu√°rio n√£o encontrado:', otherUserId);
                showError('Usu√°rio n√£o encontrado');
                return;
            }
            
            // Criar ID da conversa (ordenado para ser √∫nico)
            const conversationId = [currentUser.uid, otherUserId].sort().join('_');
            
            console.log('ID da conversa:', conversationId);
            
            try {
                // Verificar se conversa j√° existe
                const conversationRef = chatDb.ref(`userConversations/${currentUser.uid}/${conversationId}`);
                const snapshot = await conversationRef.once('value');
                
                if (!snapshot.exists()) {
                    // Criar conversa para ambos os usu√°rios
                    const conversationData = {
                        participants: {
                            [currentUser.uid]: true,
                            [otherUserId]: true
                        },
                        lastMessage: '',
                        lastTimestamp: Date.now(),
                        unreadCount: 0
                    };
                    
                    await conversationRef.set(conversationData);
                    await chatDb.ref(`userConversations/${otherUserId}/${conversationId}`).set(conversationData);
                    
                    console.log('‚úÖ Nova conversa criada');
                }
                
                // Abrir a conversa
                openConversation(conversationId, otherUserId);
                
            } catch (error) {
                console.error('‚ùå Erro ao criar conversa:', error);
                showError('Erro ao iniciar conversa');
            }
        }

        // ========== ABRIR CONVERSA ==========
        function openConversation(conversationId, otherUserId) {
            console.log('üìÇ Abrindo conversa:', conversationId, 'com usu√°rio:', otherUserId);
            
            currentConversation = conversationId;
            
            // Encontrar informa√ß√µes REAIS do outro usu√°rio
            const otherUser = allRealUsers.find(u => u.uid === otherUserId);
            
            if (!otherUser) {
                console.error('‚ùå Usu√°rio n√£o encontrado para conversa');
                return;
            }
            
            // Ativar item na lista
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-conversation="${conversationId}"]`)?.classList.add('active');
            
            // Atualizar cabe√ßalho
            chatInfoDefault.classList.add('hidden');
            chatInfoActive.classList.remove('hidden');
            
            activeUserName.textContent = otherUser.nome;
            activeUserPerfil.textContent = otherUser.perfil;
            
            // Verificar se est√° online
            const isOnline = onlineUsersCache[otherUserId]?.isOnline;
            activeUserStatus.textContent = isOnline ? '‚óè online' : '‚óè offline';
            activeUserStatus.style.color = isOnline ? '#4caf50' : '#999';
            
            // Gerar avatar
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(otherUser.nome)}&background=667eea&color=fff`;
            activeUserAvatar.src = avatarUrl;
            
            // Mostrar √°rea de input
            messageInputArea.classList.remove('hidden');
            messageInput.focus();
            
            // Carregar mensagens
            loadMessages(conversationId);
        }

        // ========== CARREGAR MENSAGENS ==========
        function loadMessages(conversationId) {
            console.log('üì® Carregando mensagens da conversa:', conversationId);
            
            // Remover listener anterior
            if (messagesRef) {
                messagesRef.off();
            }
            
            // Ouvir mensagens desta conversa
            messagesRef = chatDb.ref(`messages/${conversationId}`);
            messagesRef.orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
                const messagesData = snapshot.val();
                const messages = [];
                
                if (messagesData) {
                    Object.keys(messagesData).forEach(key => {
                        messages.push({ id: key, ...messagesData[key] });
                    });
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    renderMessages(messages);
                    console.log(`üìä ${messages.length} mensagens carregadas`);
                } else {
                    messagesContainer.innerHTML = `
                        <div class="no-messages">
                            <i class="fas fa-comment-slash"></i>
                            <p>Nenhuma mensagem ainda</p>
                            <small>Envie a primeira mensagem!</small>
                        </div>`;
                    console.log('üì≠ Nenhuma mensagem nesta conversa');
                }
            });
        }

        // ========== ENVIAR MENSAGEM ==========
        async function sendMessage() {
            if (!currentUser || !currentConversation || !messageInput.value.trim()) {
                return;
            }
            
            const text = messageInput.value.trim();
            const messageId = chatDb.ref().push().key;
            const timestamp = Date.now();
            
            console.log('üì§ Enviando mensagem:', text);
            
            try {
                // 1. Salvar mensagem
                await chatDb.ref(`messages/${currentConversation}/${messageId}`).set({
                    id: messageId,
                    senderId: currentUser.uid,
                    senderName: currentUser.nome,
                    senderLogin: currentUser.login,
                    text: text,
                    timestamp: timestamp,
                    read: false
                });
                
                // 2. Encontrar o outro usu√°rio da conversa
                const otherUserId = getOtherUserIdFromConversation(currentConversation);
                
                if (!otherUserId) {
                    throw new Error('N√£o foi poss√≠vel identificar o destinat√°rio');
                }
                
                // 3. Atualizar conversa para AMBOS os usu√°rios
                const conversationUpdate = {
                    lastMessage: text,
                    lastTimestamp: timestamp
                };
                
                await chatDb.ref(`userConversations/${currentUser.uid}/${currentConversation}`).update(conversationUpdate);
                await chatDb.ref(`userConversations/${otherUserId}/${currentConversation}`).update(conversationUpdate);
                
                console.log('‚úÖ Mensagem enviada e conversa atualizada');
                
                // 4. Limpar input
                messageInput.value = '';
                scrollToBottom();
                
            } catch (error) {
                console.error('‚ùå Erro ao enviar mensagem:', error);
                showError('Erro ao enviar mensagem: ' + error.message);
            }
        }

        // ========== FUN√á√ïES AUXILIARES ==========
        function getOtherUserId(participants) {
            if (!participants) return null;
            const participantIds = Object.keys(participants);
            return participantIds.find(id => id !== currentUser.uid);
        }

        function getOtherUserIdFromConversation(conversationId) {
            const parts = conversationId.split('_');
            return parts.find(part => part !== currentUser.uid);
        }

        function renderMessages(messages) {
            messagesContainer.innerHTML = '';
            
            messages.forEach(msg => {
                const div = document.createElement('div');
                const isSent = msg.senderId === currentUser.uid;
                const time = formatTime(msg.timestamp);
                
                div.className = `message ${isSent ? 'sent' : 'received'}`;
                div.innerHTML = `
                    <div class="message-header">
                        <span class="message-sender">${msg.senderName}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${formatMessageText(msg.text)}</div>
                `;
                
                messagesContainer.appendChild(div);
            });
            
            scrollToBottom();
        }

        function showStatus(message, type) {
            loginStatus.textContent = message;
            loginStatus.style.color = type === 'error' ? '#f44336' : 
                                    type === 'success' ? '#4caf50' : '#2196f3';
            loginStatus.style.display = 'block';
            
            setTimeout(() => {
                loginStatus.style.display = 'none';
            }, 3000);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }

        function formatMessageText(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>')
                .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: inherit; text-decoration: underline;">$1</a>');
        }

        function scrollToBottom() {
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <span>${message}</span>
            `;
            
            // Adicionar ao chat
            const chatHeader = document.querySelector('.chat-header');
            if (chatHeader) {
                chatHeader.parentNode.insertBefore(errorDiv, chatHeader.nextSibling);
                
                // Remover ap√≥s 5 segundos
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }
        }

        // ========== DESCONEX√ÉO ==========
        async function handleLogout() {
            if (currentUser) {
                try {
                    console.log('üëã Fazendo logout...');
                    
                    // Marcar como offline
                    await chatDb.ref(`users/${currentUser.uid}`).update({
                        isOnline: false,
                        lastSeen: Date.now()
                    });
                    
                    // Limpar listeners
                    if (conversationsRef) conversationsRef.off();
                    if (usersRef) usersRef.off();
                    if (messagesRef) messagesRef.off();
                    
                    // Limpar estado
                    currentUser = null;
                    currentConversation = null;
                    allRealUsers = [];
                    onlineUsersCache = {};
                    
                    // Recarregar a p√°gina
                    window.location.reload();
                    
                } catch (error) {
                    console.error('‚ùå Erro no logout:', error);
                }
            }
        }

        // ========== INICIAR APP ==========
        document.addEventListener('DOMContentLoaded', init);
    </script>

    <style>
        /* Estilos para o seletor de usu√°rio */
        .user-selector-container {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: white;
        }
        
        .user-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .user-select-dropdown {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            background: #f8f9fa;
            color: #333;
        }
        
        .user-select-dropdown:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }
        
        .btn-confirm-user {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-confirm-user:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-confirm-user:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .login-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            min-height: 20px;
            display: none;
        }
        
        /* Estilos gerais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            color: #333;
        }
        
        .container {
            width: 100%;
            height: 100%;
        }
        
        .screen {
            width: 100%;
            height: 100%;
            display: flex;
        }
        
        /* SIDEBAR */
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }
        
        .header-left {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .sidebar-header h3 {
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .app-name {
            font-size: 12px;
            color: #667eea;
            background: #f0f2f5;
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .btn-logout {
            background: #f0f2f5;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            background: #ffebee;
            color: #f44336;
            transform: rotate(-90deg);
        }
        
        /* USU√ÅRIO ATUAL */
        .user-info {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #eee;
            background: white;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .user-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .user-name {
            font-weight: 700;
            color: #333;
            font-size: 18px;
        }
        
        .user-info-bottom {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .user-login {
            font-size: 13px;
            color: #666;
            background: #f0f2f5;
            padding: 3px 10px;
            border-radius: 10px;
        }
        
        .user-perfil {
            font-size: 12px;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .status-online {
            font-size: 12px;
            color: #4caf50;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-online:before {
            content: '‚óè';
            font-size: 16px;
        }
        
        /* PESQUISA */
        .search-container {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }
        
        .search-group input {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            padding: 12px 12px 12px 45px;
            font-size: 14px;
        }
        
        .search-group i {
            color: #999;
            font-size: 16px;
        }
        
        /* SE√á√ïES */
        .section-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f0f2f5;
        }
        
        .section-header h4 {
            font-size: 14px;
            color: #666;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .count-badge {
            background: #667eea;
            color: white;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            min-width: 25px;
            text-align: center;
            font-weight: 600;
        }
        
        /* LISTA DE CONVERSAS */
        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .loading-conversations, .loading-online {
            padding: 40px 20px;
            text-align: center;
            color: #666;
        }
        
        .loading-conversations i, .loading-online i {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .loading-conversations p, .loading-online p {
            font-size: 14px;
            color: #888;
        }
        
        .conversation-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .conversation-item:hover {
            background: #f8f9fa;
        }
        
        .conversation-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-left: 3px solid #667eea;
        }
        
        .conversation-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e1e5e9;
        }
        
        .conversation-details {
            flex: 1;
            min-width: 0;
        }
        
        .conversation-name {
            font-weight: 600;
            color: #333;
            font-size: 15px;
            margin-bottom: 4px;
        }
        
        .conversation-last-message {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .conversation-time {
            font-size: 11px;
            color: #999;
            white-space: nowrap;
        }
        
        .unread-badge {
            background: #f44336;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            font-weight: 600;
        }
        
        /* USU√ÅRIOS ONLINE */
        .online-users {
            padding: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .user-online-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .user-online-item:hover {
            background: #f8f9fa;
        }
        
        .user-online-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #4caf50;
        }
        
        .user-online-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .user-online-perfil {
            font-size: 12px;
            color: #666;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
            box-shadow: 0 0 5px #4caf50;
            margin-left: auto;
        }
        
        /* √ÅREA PRINCIPAL */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .chat-info-default, .chat-info-active {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .default-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        .default-content h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .default-content p {
            color: #666;
            font-size: 14px;
        }
        
        .active-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .active-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
        }
        
        .active-user-info h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .active-user-details {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-perfil-small {
            font-size: 12px;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2px 8px;
            border-radius: 8px;
        }
        
        .user-status {
            font-size: 12px;
            color: #4caf50;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-status:before {
            content: '‚óè';
            font-size: 14px;
        }
        
        .chat-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-action {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            border: 2px solid #e1e5e9;
            background: white;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .btn-action:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f8f9fa;
        }
        
        /* √ÅREA DE MENSAGENS */
        .messages-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #666;
        }
        
        .welcome-icon {
            font-size: 80px;
            color: #667eea;
            margin-bottom: 30px;
            opacity: 0.7;
        }
        
        .welcome-content h3 {
            font-size: 28px;
            color: #333;
            margin-bottom: 15px;
        }
        
        .welcome-content p {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
            max-width: 500px;
            line-height: 1.6;
        }
        
        .welcome-features {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .feature {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .feature i {
            font-size: 24px;
            color: #667eea;
        }
        
        .feature span {
            font-size: 14px;
            color: #666;
        }
        
        /* MENSAGENS */
        .message {
            max-width: 70%;
            padding: 15px;
            border-radius: 18px;
            margin-bottom: 15px;
            position: relative;
            animation: fadeIn 0.3s ease-out;
            word-wrap: break-word;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message.received {
            align-self: flex-start;
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .message-sender {
            font-weight: 600;
            font-size: 13px;
        }
        
        .message-time {
            opacity: 0.8;
            font-size: 12px;
        }
        
        .message.received .message-time {
            color: #888;
        }
        
        .message-text {
            line-height: 1.5;
            font-size: 15px;
        }
        
        .message-text a {
            color: inherit;
            text-decoration: underline;
        }
        
        .message.sent .message-text a {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* INPUT DE MENSAGEM */
        .message-input-area {
            background: white;
            padding: 20px 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            border-top: 1px solid #ddd;
        }
        
        .input-tools {
            display: flex;
            gap: 10px;
        }
        
        .btn-tool {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid #e1e5e9;
            background: white;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .btn-tool:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f8f9fa;
        }
        
        #message-input {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        #message-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-send {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        /* NO CONVERSATIONS / NO USERS */
        .no-conversations, .no-users {
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }
        
        .no-conversations i, .no-users i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* RESPONSIVIDADE */
        @media (max-width: 1200px) {
            .sidebar {
                width: 300px;
            }
        }
        
        @media (max-width: 768px) {
            .screen {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
            }
            
            .main-content {
                height: 60vh;
            }
            
            .message {
                max-width: 85%;
            }
            
            .user-selector {
                flex-direction: column;
            }
        }
    </style>
</body>
</html>
