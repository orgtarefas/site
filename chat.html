<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat OrgTarefas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div id="chat-screen" class="screen">
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="header-left">
                        <h3><i class="fas fa-comments"></i> Mensagens</h3>
                        <span class="app-name">OrgTarefas</span>
                    </div>
                    <button id="back-btn" class="btn-logout" onclick="window.location.href='index.html'">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                
                <!-- Seletor de Usu√°rio -->
                <div class="user-selector-container">
                    <div class="section-header">
                        <h4><i class="fas fa-user"></i> Eu sou</h4>
                    </div>
                    <div class="user-selector">
                        <select id="user-select" class="user-select-dropdown">
                            <option value="">Selecione seu usu√°rio...</option>
                        </select>
                        <button id="confirm-user-btn" class="btn-confirm-user" disabled>
                            <i class="fas fa-check"></i> Entrar no Chat
                        </button>
                    </div>
                    <div id="login-status" class="login-status"></div>
                    <div id="debug-info" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; font-size: 12px; color: #666; display: none;"></div>
                </div>
                
                <!-- √Årea do Usu√°rio Logado (hidden por padr√£o) -->
                <div class="user-info hidden" id="logged-user-area">
                    <img id="user-avatar" src="" alt="Avatar" class="user-avatar">
                    <div class="user-details">
                        <span id="current-user-name" class="user-name">Carregando...</span>
                        <div class="user-info-bottom">
                            <span id="current-user-login" class="user-login"></span>
                            <span id="current-user-perfil" class="user-perfil"></span>
                            <span id="online-status" class="status-online">‚óè online</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- √Årea principal -->
            <div class="main-content">
                <div class="chat-header">
                    <div class="chat-info-default">
                        <div class="default-icon">
                            <i class="fas fa-comment-dots"></i>
                        </div>
                        <div class="default-content">
                            <h2>Bem-vindo ao Chat</h2>
                            <p>Selecione seu usu√°rio para come√ßar</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // ========== CONFIGURA√á√ÉO FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAs0Ke4IBfBWDrfH0AXaOhCEjtfpPtR_Vg",
            authDomain: "orgtarefas-85358.firebaseapp.com",
            projectId: "orgtarefas-85358",
            storageBucket: "orgtarefas-85358.firebasestorage.app",
            messagingSenderId: "1023569488575",
            appId: "1:1023569488575:web:18f9e201115a1a92ccb40a"
        };

        const chatFirebaseConfig = {
            apiKey: "AIzaSyAYROPCh-558mNXPrO7onAXFvfBe13q5Js",
            authDomain: "orgtarefas-chat.firebaseapp.com",
            databaseURL: "https://orgtarefas-chat-default-rtdb.firebaseio.com",
            projectId: "orgtarefas-chat",
            storageBucket: "orgtarefas-chat.firebasestorage.app",
            messagingSenderId: "380919096800",
            appId: "1:380919096800:web:7b54e7e341c9266c207785"
        };

        // ========== VARI√ÅVEIS GLOBAIS ==========
        let db, chatDb, currentUser = null;

        // ========== INICIALIZAR FIREBASE ==========
        function initializeFirebase() {
            try {
                console.log('üöÄ Inicializando Firebase...');
                
                // Inicializar primeiro app (Firestore - sistema principal)
                const mainApp = firebase.initializeApp(firebaseConfig);
                console.log('‚úÖ Firebase App (Firestore) inicializado');
                
                // Inicializar segundo app (Realtime Database - chat)
                const chatApp = firebase.initializeApp(chatFirebaseConfig, 'chatApp');
                console.log('‚úÖ Firebase App (Chat) inicializado');
                
                // Obter refer√™ncias
                db = firebase.firestore(mainApp);
                chatDb = firebase.database(chatApp);
                
                console.log('‚úÖ Firestore e Realtime Database configurados');
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Firebase:', error);
                showStatus('Erro ao conectar com o servidor: ' + error.message, 'error');
                return false;
            }
        }

        // ========== ELEMENTOS DOM ==========
        let userSelect, confirmUserBtn, loginStatus, debugInfo;

        // ========== INICIALIZA√á√ÉO ==========
        async function init() {
            console.log('üöÄ Inicializando chat...');
            
            // 1. Inicializar Firebase
            if (!initializeFirebase()) {
                return;
            }
            
            // 2. Configurar elementos DOM
            setupDOM();
            
            // 3. Configurar event listeners
            setupEventListeners();
            
            // 4. Carregar usu√°rios da cole√ß√£o CORRETA
            await loadUsersFromFirestore();
        }

        // ========== CONFIGURAR ELEMENTOS DOM ==========
        function setupDOM() {
            userSelect = document.getElementById('user-select');
            confirmUserBtn = document.getElementById('confirm-user-btn');
            loginStatus = document.getElementById('login-status');
            debugInfo = document.getElementById('debug-info');
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            // Seletor de usu√°rio
            if (userSelect) {
                userSelect.addEventListener('change', (e) => {
                    if (confirmUserBtn) {
                        confirmUserBtn.disabled = !e.target.value;
                    }
                });
            }
            
            if (confirmUserBtn) {
                confirmUserBtn.addEventListener('click', handleUserSelection);
            }
        }

        // ========== CARREGAR USU√ÅRIOS DO FIRESTORE ==========
        async function loadUsersFromFirestore() {
            try {
                console.log('üîç Buscando usu√°rios da cole√ß√£o "usuarios"...');
                showStatus('Buscando usu√°rios...', 'info');
                showDebugInfo('Analisando estrutura dos documentos...');
                
                if (!db) {
                    throw new Error('Firestore n√£o inicializado');
                }
                
                // BUSCAR DA COLE√á√ÉO "usuarios"
                const querySnapshot = await db.collection('usuarios').get();
                console.log(`üìÑ Total de documentos em "usuarios": ${querySnapshot.size}`);
                
                let usuariosReais = [];
                let debugText = `Encontrados ${querySnapshot.size} documento(s):<br><br>`;
                
                querySnapshot.forEach((doc, index) => {
                    const docId = doc.id;
                    const dados = doc.data();
                    
                    console.log(`üìã Documento ${index + 1} (ID: ${docId}):`, dados);
                    debugText += `üìÑ Documento ${index + 1} (${docId}):<br>`;
                    debugText += JSON.stringify(dados, null, 2).replace(/\n/g, '<br>').replace(/ /g, '&nbsp;') + '<br><br>';
                    
                    // ESTRAT√âGIA 1: Verificar estrutura direta (campo "usuario")
                    if (dados.usuario) {
                        console.log(`‚úÖ ESTRUTURA 1 - Campo "usuario": ${dados.usuario}`);
                        
                        const usuario = {
                            uid: docId,
                            docId: docId,
                            login: dados.usuario,
                            nome: dados.nome || dados.displayName || dados.usuario,
                            perfil: dados.nivel || dados.perfil || dados.role || 'usuario',
                            email: dados.email || '',
                            senha: dados.senha || ''
                        };
                        
                        usuariosReais.push(usuario);
                        debugText += `‚úÖ ESTRUTURA 1 - Usu√°rio adicionado: ${usuario.nome}<br><br>`;
                    }
                    // ESTRAT√âGIA 2: Verificar estrutura com "login" (mais antiga)
                    else if (dados.login) {
                        console.log(`‚úÖ ESTRUTURA 2 - Campo "login": ${dados.login}`);
                        
                        const usuario = {
                            uid: docId,
                            docId: docId,
                            login: dados.login,
                            nome: dados.nome || dados.displayName || dados.login,
                            perfil: dados.perfil || dados.nivel || 'usuario',
                            email: dados.email || '',
                            senha: dados.senha || ''
                        };
                        
                        usuariosReais.push(usuario);
                        debugText += `‚úÖ ESTRUTURA 2 - Usu√°rio adicionado: ${usuario.nome}<br><br>`;
                    }
                    // ESTRAT√âGIA 3: Verificar se tem campos que indicam ser usu√°rio
                    else if (dados.email || dados.nome || dados.displayName) {
                        console.log(`‚ö†Ô∏è ESTRUTURA 3 - Poss√≠vel usu√°rio sem campo de login`);
                        
                        // Tentar extrair login do email ou nome
                        const login = dados.email ? dados.email.split('@')[0] : 
                                     dados.nome ? dados.nome.toLowerCase().replace(/\s+/g, '.') :
                                     dados.displayName ? dados.displayName.toLowerCase().replace(/\s+/g, '.') : 
                                     `user_${docId}`;
                        
                        const usuario = {
                            uid: docId,
                            docId: docId,
                            login: login,
                            nome: dados.nome || dados.displayName || login,
                            perfil: dados.perfil || dados.nivel || dados.role || 'usuario',
                            email: dados.email || '',
                            senha: dados.senha || ''
                        };
                        
                        usuariosReais.push(usuario);
                        debugText += `‚úÖ ESTRUTURA 3 - Usu√°rio inferido: ${usuario.nome}<br><br>`;
                    }
                    // ESTRAT√âGIA 4: Verificar campos aninhados (objetos dentro do documento)
                    else {
                        // Procurar por objetos que possam conter dados de usu√°rio
                        Object.keys(dados).forEach(campo => {
                            const valor = dados[campo];
                            if (typeof valor === 'object' && valor !== null) {
                                console.log(`üîç Campo aninhado "${campo}":`, valor);
                                debugText += `üîç Campo aninhado "${campo}": ${JSON.stringify(valor)}<br>`;
                                
                                if (valor.usuario || valor.login) {
                                    const userObj = valor;
                                    const usuario = {
                                        uid: `${docId}_${campo}`,
                                        docId: docId,
                                        campo: campo,
                                        login: userObj.usuario || userObj.login,
                                        nome: userObj.nome || userObj.displayName || (userObj.usuario || userObj.login),
                                        perfil: userObj.perfil || userObj.nivel || 'usuario',
                                        email: userObj.email || '',
                                        senha: userObj.senha || ''
                                    };
                                    
                                    usuariosReais.push(usuario);
                                    debugText += `‚úÖ Usu√°rio aninhado adicionado: ${usuario.nome}<br><br>`;
                                }
                            }
                        });
                    }
                });
                
                console.log(`üéØ Total de usu√°rios encontrados: ${usuariosReais.length}`);
                console.log('üë• Usu√°rios:', usuariosReais);
                
                // Mostrar debug info
                if (debugInfo) {
                    debugInfo.innerHTML = debugText;
                    debugInfo.style.display = 'block';
                }
                
                if (usuariosReais.length > 0) {
                    // Ordenar por nome
                    usuariosReais.sort((a, b) => a.nome.localeCompare(b.nome));
                    
                    // Adicionar ao select
                    usuariosReais.forEach(usuario => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify(usuario);
                        option.textContent = `${usuario.nome} (${usuario.login}) - ${usuario.perfil}`;
                        if (userSelect) {
                            userSelect.appendChild(option);
                        }
                    });
                    
                    showStatus(`${usuariosReais.length} usu√°rio(s) carregado(s)`, 'success');
                    
                    // Tentar detectar usu√°rio logado do localStorage
                    try {
                        const usuarioLogadoStr = localStorage.getItem('usuarioLogado');
                        if (usuarioLogadoStr) {
                            const usuarioLogado = JSON.parse(usuarioLogadoStr);
                            console.log('üë§ Usu√°rio logado detectado:', usuarioLogado);
                            
                            // Procurar usu√°rio correspondente
                            for (let i = 0; i < userSelect.options.length; i++) {
                                if (userSelect.options[i].value) {
                                    try {
                                        const usuarioOpt = JSON.parse(userSelect.options[i].value);
                                        if (usuarioOpt.login === usuarioLogado.usuario) {
                                            userSelect.selectedIndex = i;
                                            if (confirmUserBtn) {
                                                confirmUserBtn.disabled = false;
                                            }
                                            showStatus(`Usu√°rio ${usuarioLogado.nome} detectado`, 'success');
                                            break;
                                        }
                                    } catch (e) {
                                        // Ignorar erro de parse
                                    }
                                }
                            }
                        }
                    } catch (e) {
                        console.log('N√£o foi poss√≠vel detectar usu√°rio logado:', e);
                    }
                    
                } else {
                    showStatus('Nenhum usu√°rio encontrado com estrutura reconhecida', 'error');
                    
                    // Mostrar mensagem de ajuda
                    if (debugInfo) {
                        debugInfo.innerHTML += '<br><strong>üí° DICA:</strong> A estrutura esperada √© um documento com campos:<br>' +
                                             '- "usuario" ou "login" (nome de usu√°rio)<br>' +
                                             '- "nome" ou "displayName" (nome completo)<br>' +
                                             '- "perfil", "nivel" ou "role" (tipo de usu√°rio)<br>' +
                                             '- "email" (opcional)<br>' +
                                             '- "senha" (opcional)';
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
                showStatus('Erro: ' + error.message, 'error');
            }
        }

        // ========== SELE√á√ÉO DE USU√ÅRIO ==========
        async function handleUserSelection() {
            if (!userSelect || !userSelect.value) return;
            
            try {
                const userData = JSON.parse(userSelect.value);
                console.log('üë§ Usu√°rio selecionado:', userData);
                showStatus('Conectando ao chat...', 'info');
                
                currentUser = userData;
                showStatus(`‚úÖ Bem-vindo, ${currentUser.nome}!`, 'success');
                
                // Aqui voc√™ pode continuar com a l√≥gica do chat
                // Ex: setupChatUser(userData);
                
            } catch (error) {
                console.error('Erro ao selecionar usu√°rio:', error);
                showStatus('Erro ao selecionar usu√°rio', 'error');
            }
        }

        // ========== FUN√á√ïES AUXILIARES ==========
        function showStatus(message, type) {
            if (!loginStatus) return;
            
            loginStatus.textContent = message;
            loginStatus.className = 'login-status';
            
            switch(type) {
                case 'error':
                    loginStatus.style.color = '#f44336';
                    loginStatus.style.backgroundColor = '#ffebee';
                    break;
                case 'success':
                    loginStatus.style.color = '#4caf50';
                    loginStatus.style.backgroundColor = '#e8f5e8';
                    break;
                default:
                    loginStatus.style.color = '#2196f3';
                    loginStatus.style.backgroundColor = '#e3f2fd';
            }
            
            loginStatus.style.display = 'block';
        }

        function showDebugInfo(message) {
            if (!debugInfo) return;
            debugInfo.innerHTML += message + '<br>';
            debugInfo.style.display = 'block';
        }

        // ========== INICIAR APP ==========
        document.addEventListener('DOMContentLoaded', init);
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            color: #333;
        }
        
        .container {
            width: 100%;
            height: 100%;
        }
        
        .screen {
            width: 100%;
            height: 100%;
            display: flex;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .sidebar-header h3 {
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .app-name {
            font-size: 12px;
            color: #667eea;
            background: #f0f2f5;
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .btn-logout {
            background: #f0f2f5;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            background: #ffebee;
            color: #f44336;
            transform: rotate(-90deg);
        }
        
        .user-selector-container {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .section-header {
            margin-bottom: 15px;
        }
        
        .section-header h4 {
            font-size: 14px;
            color: #666;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .user-select-dropdown {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            background: #f8f9fa;
            color: #333;
        }
        
        .user-select-dropdown:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }
        
        .btn-confirm-user {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-confirm-user:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-confirm-user:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .login-status {
            margin-top: 10px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #ddd;
        }
        
        .chat-info-default {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .default-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        .default-content h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .default-content p {
            color: #666;
            font-size: 14px;
        }
        
        .user-info {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #eee;
            background: white;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .user-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .user-name {
            font-weight: 700;
            color: #333;
            font-size: 18px;
        }
        
        .user-info-bottom {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .user-login {
            font-size: 13px;
            color: #666;
            background: #f0f2f5;
            padding: 3px 10px;
            border-radius: 10px;
        }
        
        .user-perfil {
            font-size: 12px;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .status-online {
            font-size: 12px;
            color: #4caf50;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-online:before {
            content: '‚óè';
            font-size: 16px;
        }
    </style>
</body>
</html>
