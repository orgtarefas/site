<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat OrgTarefas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div id="chat-screen" class="screen">
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="header-left">
                        <h3><i class="fas fa-comments"></i> Mensagens</h3>
                        <span class="app-name">OrgTarefas</span>
                    </div>
                    <button id="back-btn" class="btn-logout" onclick="window.location.href='index.html'">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                
                <!-- Seletor de Usu√°rio -->
                <div class="user-selector-container">
                    <div class="section-header">
                        <h4><i class="fas fa-user"></i> Eu sou</h4>
                    </div>
                    <div class="user-selector">
                        <select id="user-select" class="user-select-dropdown">
                            <option value="">Selecione seu usu√°rio...</option>
                        </select>
                        <button id="confirm-user-btn" class="btn-confirm-user" disabled>
                            <i class="fas fa-check"></i> Entrar no Chat
                        </button>
                    </div>
                    <div id="login-status" class="login-status"></div>
                </div>
                
                <!-- √Årea do Usu√°rio Logado (hidden por padr√£o) -->
                <div class="user-info hidden" id="logged-user-area">
                    <img id="user-avatar" src="" alt="Avatar" class="user-avatar">
                    <div class="user-details">
                        <span id="current-user-name" class="user-name">Carregando...</span>
                        <div class="user-info-bottom">
                            <span id="current-user-login" class="user-login"></span>
                            <span id="current-user-perfil" class="user-perfil"></span>
                            <span id="online-status" class="status-online">‚óè online</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- √Årea principal -->
            <div class="main-content">
                <div class="chat-header">
                    <div class="chat-info-default">
                        <div class="default-icon">
                            <i class="fas fa-comment-dots"></i>
                        </div>
                        <div class="default-content">
                            <h2>Bem-vindo ao Chat</h2>
                            <p>Selecione seu usu√°rio para come√ßar</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // ========== CONFIGURA√á√ÉO FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAs0Ke4IBfBWDrfH0AXaOhCEjtfpPtR_Vg",
            authDomain: "orgtarefas-85358.firebaseapp.com",
            projectId: "orgtarefas-85358",
            storageBucket: "orgtarefas-85358.firebasestorage.app",
            messagingSenderId: "1023569488575",
            appId: "1:1023569488575:web:18f9e201115a1a92ccb40a"
        };

        const chatFirebaseConfig = {
            apiKey: "AIzaSyAYROPCh-558mNXPrO7onAXFvfBe13q5Js",
            authDomain: "orgtarefas-chat.firebaseapp.com",
            databaseURL: "https://orgtarefas-chat-default-rtdb.firebaseio.com",
            projectId: "orgtarefas-chat",
            storageBucket: "orgtarefas-chat.firebasestorage.app",
            messagingSenderId: "380919096800",
            appId: "1:380919096800:web:7b54e7e341c9266c207785"
        };

        // ========== VARI√ÅVEIS GLOBAIS ==========
        let db, chatDb, currentUser = null;

        // ========== INICIALIZAR FIREBASE ==========
        function initializeFirebase() {
            try {
                console.log('üöÄ Inicializando Firebase...');
                
                const mainApp = firebase.initializeApp(firebaseConfig);
                console.log('‚úÖ Firebase App (Firestore) inicializado');
                
                const chatApp = firebase.initializeApp(chatFirebaseConfig, 'chatApp');
                console.log('‚úÖ Firebase App (Chat) inicializado');
                
                db = firebase.firestore(mainApp);
                chatDb = firebase.database(chatApp);
                
                console.log('‚úÖ Firestore e Realtime Database configurados');
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Firebase:', error);
                showStatus('Erro ao conectar com o servidor: ' + error.message, 'error');
                return false;
            }
        }

        // ========== ELEMENTOS DOM ==========
        let userSelect, confirmUserBtn, loginStatus;

        // ========== INICIALIZA√á√ÉO ==========
        async function init() {
            console.log('üöÄ Inicializando chat...');
            
            if (!initializeFirebase()) {
                return;
            }
            
            setupDOM();
            setupEventListeners();
            
            // Verificar auto-login primeiro
            const autoLogged = await tryAutoLogin();
            
            // Carregar lista de usu√°rios (se n√£o fez auto-login)
            if (!autoLogged) {
                await loadUsersFromFirestore();
            }
        }

        // ========== CONFIGURAR ELEMENTOS DOM ==========
        function setupDOM() {
            userSelect = document.getElementById('user-select');
            confirmUserBtn = document.getElementById('confirm-user-btn');
            loginStatus = document.getElementById('login-status');
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            if (userSelect) {
                userSelect.addEventListener('change', (e) => {
                    if (confirmUserBtn) {
                        confirmUserBtn.disabled = !e.target.value;
                    }
                });
            }
            
            if (confirmUserBtn) {
                confirmUserBtn.addEventListener('click', handleUserSelection);
            }
        }

        // ========== TENTAR AUTO-LOGIN ==========
        async function tryAutoLogin() {
            try {
                const usuarioLogadoStr = localStorage.getItem('usuarioLogado');
                if (usuarioLogadoStr) {
                    const usuarioLogado = JSON.parse(usuarioLogadoStr);
                    console.log('üë§ Tentando auto-login para:', usuarioLogado.usuario);
                    
                    // Buscar usu√°rio no Firestore
                    const querySnapshot = await db.collection('usuarios')
                        .where('usuario', '==', usuarioLogado.usuario)
                        .get();
                    
                    if (!querySnapshot.empty) {
                        const doc = querySnapshot.docs[0];
                        const userData = doc.data();
                        
                        console.log('‚úÖ Usu√°rio encontrado para auto-login:', userData);
                        
                        // Criar objeto de usu√°rio para o chat
                        const usuarioChat = {
                            uid: doc.id,
                            docId: doc.id,
                            login: userData.usuario,
                            nome: userData.usuario, // Usar o pr√≥prio usu√°rio como nome (j√° que n√£o tem campo "nome")
                            perfil: userData.nivel || 'usuario',
                            email: '', // N√£o tem email na estrutura
                            status: userData.ativo ? 'Ativo' : 'Inativo'
                        };
                        
                        // Fazer auto-login
                        await performAutoLogin(usuarioChat);
                        return true;
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro no auto-login:', error);
            }
            return false;
        }

        // ========== REALIZAR AUTO-LOGIN ==========
        async function performAutoLogin(userData) {
            console.log('üîë Realizando auto-login para:', userData.login);
            
            currentUser = userData;
            
            // Mostrar mensagem
            showStatus(`Bem-vindo de volta, ${userData.login}!`, 'success');
            
            // Configurar usu√°rio no chat
            await setupChatUser(currentUser);
            
            // Atualizar interface
            updateUserInterface();
            
            // Configurar listeners em tempo real
            setupRealtimeListeners();
            
            // N√£o mostrar seletor de usu√°rio
            const userSelectorContainer = document.querySelector('.user-selector-container');
            if (userSelectorContainer) {
                userSelectorContainer.style.display = 'none';
            }
        }

        // ========== CARREGAR USU√ÅRIOS DO FIRESTORE ==========
        async function loadUsersFromFirestore() {
            try {
                console.log('üîç Buscando todos os usu√°rios...');
                showStatus('Buscando usu√°rios...', 'info');
                
                const querySnapshot = await db.collection('usuarios').get();
                console.log(`üìÑ Total de documentos: ${querySnapshot.size}`);
                
                let usuariosReais = [];
                
                querySnapshot.forEach(doc => {
                    const dados = doc.data();
                    
                    // Verificar se tem campo "usuario" (estrutura do seu banco)
                    if (dados.usuario) {
                        console.log(`‚úÖ Usu√°rio encontrado: ${dados.usuario}`);
                        
                        const usuario = {
                            uid: doc.id,
                            docId: doc.id,
                            login: dados.usuario,
                            nome: dados.usuario, // Usar o login como nome
                            perfil: dados.nivel || 'usuario',
                            email: '', // N√£o tem email
                            status: dados.ativo ? 'Ativo' : 'Inativo'
                        };
                        
                        usuariosReais.push(usuario);
                    }
                });
                
                console.log(`üéØ Total de usu√°rios encontrados: ${usuariosReais.length}`);
                
                if (usuariosReais.length > 0) {
                    // Adicionar ao select
                    usuariosReais.forEach(usuario => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify(usuario);
                        option.textContent = `${usuario.login} - ${usuario.perfil}`;
                        if (userSelect) {
                            userSelect.appendChild(option);
                        }
                    });
                    
                    showStatus(`${usuariosReais.length} usu√°rio(s) dispon√≠vel(is)`, 'success');
                } else {
                    showStatus('Nenhum usu√°rio encontrado', 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
                showStatus('Erro: ' + error.message, 'error');
            }
        }

        // ========== SELE√á√ÉO DE USU√ÅRIO ==========
        async function handleUserSelection() {
            if (!userSelect || !userSelect.value) return;
            
            try {
                const userData = JSON.parse(userSelect.value);
                console.log('üë§ Usu√°rio selecionado:', userData);
                showStatus('Conectando ao chat...', 'info');
                
                currentUser = userData;
                
                // Configurar usu√°rio no chat
                await setupChatUser(currentUser);
                
                // Atualizar interface
                updateUserInterface();
                
                // Configurar listeners em tempo real
                setupRealtimeListeners();
                
                showStatus(`‚úÖ Bem-vindo, ${currentUser.login}!`, 'success');
                
            } catch (error) {
                console.error('Erro ao selecionar usu√°rio:', error);
                showStatus('Erro ao selecionar usu√°rio', 'error');
            }
        }

        // ========== CONFIGURAR USU√ÅRIO NO CHAT ==========
        async function setupChatUser(userData) {
            console.log('‚öôÔ∏è Configurando usu√°rio no chat:', userData);
            
            // Gerar avatar
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.login)}&background=667eea&color=fff`;
            
            // Salvar no RTDB do chat
            const userRef = chatDb.ref(`users/${userData.uid}`);
            
            try {
                await userRef.set({
                    uid: userData.uid,
                    login: userData.login,
                    nome: userData.nome,
                    perfil: userData.perfil,
                    avatarUrl: avatarUrl,
                    isOnline: true,
                    lastSeen: Date.now()
                });
                
                console.log('‚úÖ Usu√°rio salvo no RTDB');
                
                // Configurar desconex√£o autom√°tica
                userRef.child('isOnline').onDisconnect().set(false);
                userRef.child('lastSeen').onDisconnect().set(Date.now());
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar usu√°rio no RTDB:', error);
            }
        }

        // ========== ATUALIZAR INTERFACE DO USU√ÅRIO ==========
        function updateUserInterface() {
            if (!currentUser) return;
            
            // Atualizar elementos
            const userName = document.getElementById('current-user-name');
            const userLogin = document.getElementById('current-user-login');
            const userPerfil = document.getElementById('current-user-perfil');
            const userAvatar = document.getElementById('user-avatar');
            const loggedUserArea = document.getElementById('logged-user-area');
            
            if (userName) userName.textContent = currentUser.login;
            if (userLogin) userLogin.textContent = currentUser.login;
            if (userPerfil) userPerfil.textContent = currentUser.perfil;
            
            // Gerar avatar
            if (userAvatar) {
                const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.login)}&background=667eea&color=fff`;
                userAvatar.src = avatarUrl;
            }
            
            // Mostrar √°rea do usu√°rio logado
            if (loggedUserArea) {
                loggedUserArea.classList.remove('hidden');
            }
            
            // Esconder seletor
            const userSelectorContainer = document.querySelector('.user-selector-container');
            if (userSelectorContainer) {
                userSelectorContainer.style.display = 'none';
            }
            
            // Atualizar cabe√ßalho do chat
            updateChatHeader();
        }

        // ========== ATUALIZAR CABE√áALHO DO CHAT ==========
        function updateChatHeader() {
            const chatHeader = document.querySelector('.chat-header');
            if (chatHeader && currentUser) {
                chatHeader.innerHTML = `
                    <div class="chat-info-default">
                        <div class="default-icon">
                            <i class="fas fa-comment-dots"></i>
                        </div>
                        <div class="default-content">
                            <h2>Ol√°, ${currentUser.login}!</h2>
                            <p>Selecione uma conversa para come√ßar</p>
                        </div>
                    </div>
                `;
            }
        }

        // ========== LISTENERS EM TEMPO REAL ==========
        function setupRealtimeListeners() {
            if (!currentUser) return;
            
            console.log('üì° Configurando listeners em tempo real...');
            
            // Aqui voc√™ pode adicionar os listeners para:
            // 1. Conversas do usu√°rio
            // 2. Usu√°rios online
            // 3. Mensagens
        }

        // ========== FUN√á√ïES AUXILIARES ==========
        function showStatus(message, type) {
            if (!loginStatus) return;
            
            loginStatus.textContent = message;
            loginStatus.className = 'login-status';
            
            switch(type) {
                case 'error':
                    loginStatus.style.color = '#f44336';
                    loginStatus.style.backgroundColor = '#ffebee';
                    break;
                case 'success':
                    loginStatus.style.color = '#4caf50';
                    loginStatus.style.backgroundColor = '#e8f5e8';
                    break;
                default:
                    loginStatus.style.color = '#2196f3';
                    loginStatus.style.backgroundColor = '#e3f2fd';
            }
            
            loginStatus.style.display = 'block';
            
            // Limpar ap√≥s alguns segundos
            if (type !== 'error') {
                setTimeout(() => {
                    loginStatus.style.display = 'none';
                }, 3000);
            }
        }

        // ========== INICIAR APP ==========
        document.addEventListener('DOMContentLoaded', init);
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            color: #333;
        }
        
        .container {
            width: 100%;
            height: 100%;
        }
        
        .screen {
            width: 100%;
            height: 100%;
            display: flex;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .sidebar-header h3 {
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .app-name {
            font-size: 12px;
            color: #667eea;
            background: #f0f2f5;
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .btn-logout {
            background: #f0f2f5;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            background: #ffebee;
            color: #f44336;
            transform: rotate(-90deg);
        }
        
        .user-selector-container {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .section-header {
            margin-bottom: 15px;
        }
        
        .section-header h4 {
            font-size: 14px;
            color: #666;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .user-select-dropdown {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            background: #f8f9fa;
            color: #333;
        }
        
        .user-select-dropdown:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }
        
        .btn-confirm-user {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-confirm-user:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-confirm-user:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .login-status {
            margin-top: 10px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #ddd;
        }
        
        .chat-info-default {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .default-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        .default-content h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .default-content p {
            color: #666;
            font-size: 14px;
        }
        
        .user-info {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #eee;
            background: white;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .user-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .user-name {
            font-weight: 700;
            color: #333;
            font-size: 18px;
        }
        
        .user-info-bottom {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .user-login {
            font-size: 13px;
            color: #666;
            background: #f0f2f5;
            padding: 3px 10px;
            border-radius: 10px;
        }
        
        .user-perfil {
            font-size: 12px;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .status-online {
            font-size: 12px;
            color: #4caf50;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-online:before {
            content: '‚óè';
            font-size: 16px;
        }
    </style>
</body>
</html>
